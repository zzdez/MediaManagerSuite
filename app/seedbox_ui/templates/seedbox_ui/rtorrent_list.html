<!-- Specific styles for rtorrent_list, ensure they are scoped or not conflicting -->
<style>
    .table th { white-space: nowrap; }
    .torrent-name {
        max-width: 250px; /* Allow a reasonable max width */
        white-space: normal; /* Allow wrapping */
        word-break: break-all; /* Break long words */
        vertical-align: middle;
    }
    .status-downloading { color: #007bff; }
    .status-seeding { color: #28a745; }
    .status-paused { color: #ffc107; }
    .status-stopped { color: #dc3545; }
    .status-checking { color: #17a2b8; }
    .status-error { color: #dc3545; font-weight: bold; }
    .status-unknown { color: #6c757d; }
    .badge-sonarr { background-color: #0d6efd; color: white; }
    .badge-radarr { background-color: #ffc107; color: black; }
    /* Removed table-hover as it might conflict if index.html has its own general table styling for dark mode */
</style>

<!-- Removed main container, header, and flashed messages. Assumes index.html provides overall structure. -->
<!-- The content will be injected into #rtorrent-content-container -->

{% if error_message %}
    <div class="alert alert-danger mt-3" role="alert"> {# Added mt-3 for spacing #}
        <strong>Erreur rTorrent :</strong> {{ error_message }}
    </div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-3 mt-3"> {# Added mt-3 #}
    <h4 class="mb-0">Liste des Torrents rTorrent</h4> {# Retaining a title for the section within the tab #}
    <a href="#" onclick="event.preventDefault(); isRtorrentContentLoaded = false; loadRtorrentView();" class="btn btn-info btn-sm">
        <i class="fas fa-sync-alt"></i> Actualiser
    </a>
</div>

{% if torrents_with_assoc is defined and torrents_with_assoc %}
    <div id="batch-actions-container" class="mb-3" style="display: none;">
        <div class="card bg-dark border-secondary">
            <div class="card-body">
                <h5 class="card-title"><span id="selected-torrent-count">0</span> item(s) sélectionné(s)</h5>
                <p class="card-text">Choisissez une action à appliquer à tous les items sélectionnés.</p>
                <div class="btn-group" role="group" aria-label="Batch Actions">
                    <button class="btn btn-info" id="batch-map-btn" style="display: none;"><i class="bi bi-link-45deg"></i> Mapper</button>
                    <button class="btn btn-primary" id="batch-repatriate-btn" style="display: none;"><i class="bi bi-cloud-download"></i> Rapatrier</button>
                    <button class="btn btn-success" id="batch-mark-processed-btn" style="display: none;"><i class="bi bi-check-circle"></i> Marquer Traité</button>
                    <button class="btn btn-info" id="batch-retry-repatriation-btn" style="display: none;"><i class="bi bi-arrow-clockwise"></i> Réessayer Rapatriement</button>
                    <button class="btn btn-warning" id="batch-forget-btn" style="display: none;"><i class="bi bi-eraser"></i> Oublier Association</button>
                    <button class="btn btn-secondary" id="batch-ignore-btn" style="display: none;"><i class="bi bi-slash-circle"></i> Ignorer Déf.</button>
                    <button class="btn btn-danger" id="batch-delete-btn">
                        <i class="bi bi-trash-fill"></i> Supprimer la sélection
                    </button>
                </div>
                <div class="form-check form-switch d-inline-block ms-3 align-middle">
                    <input class="form-check-input" type="checkbox" id="delete-data-checkbox">
                    <label class="form-check-label" for="delete-data-checkbox">Supprimer les données (pour l'action Supprimer)</label>
                </div>
            </div>
        </div>
    </div>
    <div class="table-responsive">
        <table id="rtorrent-table" class="table table-striped table-hover table-sm caption-top table-dark"> {# Added table-dark to match index.html general theme #}
            <caption>Liste des torrents actifs et pré-associations. Les vitesses sont en Ko/s.</caption>
            <thead class="table-dark">
                <tr>
                    <th style="width: 3%;"><input class="form-check-input" type="checkbox" id="select-all-torrents"></th>
                    <th class="sortable-header" data-sort-by="name">Nom</th>
                    <th class="sortable-header" data-sort-by="size" data-sort-type="size">Taille (Go)</th>
                    <th class="sortable-header" data-sort-by="progress" data-sort-type="number">Progrès (%)</th>
                    <th class="sortable-header" data-sort-by="ratio" data-sort-type="number">Ratio</th>
                    <th>DL / UL</th>
                    <th class="sortable-header" data-sort-by="status-rtorrent">Statut rTorrent</th>
                    <th>Label rTorrent</th>
                    <th>Pré-association MMS</th>
                    <th class="sortable-header" data-sort-by="status-mms">Statut MMS</th>
                </tr>
            </thead>
            <tbody>
                {% for torrent_item in torrents_with_assoc %}
                    {% set torrent = torrent_item.details %}
                    {% set association = torrent_item.association %}
                    <tr data-mms-status="{{ torrent.mms_status or 'unknown' }}" data-association-exists="{{ 'true' if association else 'false' }}">
                        <td><input class="form-check-input torrent-checkbox" type="checkbox" data-torrent-hash="{{ torrent.hash }}"></td>
                        <td><span class="torrent-name" title="{{ torrent.name }}">{{ torrent.name }}</span></td>
                        <td>{{ (torrent.size_bytes / (1024*1024*1024)) | round(2) if torrent.size_bytes else '0.00' }}</td>
                        <td>{{ torrent.progress_percent | round(1) if torrent.progress_percent is not none else 'N/A' }}%</td>
                        <td>{{ torrent.ratio | round(2) if torrent.ratio is not none else 'N/A' }}</td>
                        <td>
                            <span class="text-success">{{ (torrent.down_rate_bytes_sec / 1024) | round(1) if torrent.down_rate_bytes_sec is not none else '0.0' }}</span> /
                            <span class="text-primary">{{ (torrent.up_rate_bytes_sec / 1024) | round(1) if torrent.up_rate_bytes_sec is not none else '0.0' }}</span>
                        </td>
                        <td class="status-{{ torrent.status_text | lower | replace(' ', '-') if torrent.status_text else 'unknown' }}">
                            {{ torrent.status_text if torrent.status_text else 'Inconnu' }}
                        </td>
                        <td>
                            {% if torrent.label %}
                                <span class="badge {% if torrent.label == config_label_sonarr %}badge-sonarr{% elif torrent.label == config_label_radarr %}badge-radarr{% else %}bg-secondary text-white{% endif %}">
                                    {{ torrent.label }}
                                </span>
                            {% else %}
                                <span class="text-muted">Aucun</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if association %}
                                <span class="badge {% if association.app_type == 'sonarr' %}badge-sonarr{% elif association.app_type == 'radarr' %}badge-radarr{% endif %}">
                                    {{ association.app_type | capitalize }}: {{ association.original_name | truncate(30) }}
                                    <small>(ID: {{ association.target_id }})</small>
                                </span>
                            {% else %}
                                <span class="text-muted">Aucune</span>
                            {% endif %}
                        </td>
                        <td>
                            {# --- NOUVEAU BLOC DE LOGIQUE DE STATUT --- #}
                            {% set status = torrent.mms_status %}
                            {% set status_msg = association.status_message if association else '' %}

                            {% if status == 'completed_auto' or status in ['imported_by_sonarr', 'imported_by_radarr', 'imported_by_sonarr_manual', 'imported_by_radarr_manual'] %}
                                <span class="badge bg-success">Traité (Auto)</span>
                            {% elif status == 'completed_manual' or status == 'imported_by_mms' %}
                                <span class="badge bg-info">Traité (MMS)</span>
                            {% elif status == 'processed_manual' %}
                                <span class="badge bg-secondary">Traité (Ignoré)</span>
                            {% elif status == 'in_staging' %}
                                <span class="badge bg-primary">En Staging</span>
                            {% elif status == 'pending_staging' %}
                                <span class="badge" style="background-color: #6f42c1;">Prêt à Rapatrier</span> {# Mauve #}
                            {% elif status == 'pending_download' %}
                                <span class="badge bg-warning text-dark">En Attente</span>
                            {% elif status and 'error' in status %}
                                <span class="badge bg-danger">Erreur</span>
                                <small class="d-block text-muted" title="{{ status_msg }}">{{ status }}</small>
                            {% elif status == 'unknown' %}
                                <span class="badge bg-secondary">Inconnu</span>
                            {% else %}
                                <span class="badge bg-dark">{{ status or 'Inconnu' }}</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% elif not error_message %}
    <div class="alert alert-info mt-3" role="alert">
        Aucun torrent trouvé dans rTorrent ou la liste n'a pas pu être chargée.
    </div>
{% endif %}

<!-- Bootstrap JS should be loaded by the main layout, so removed from here -->
