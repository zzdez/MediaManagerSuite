<!-- Specific styles for rtorrent_list, ensure they are scoped or not conflicting -->
<style>
    .table th { white-space: nowrap; }
    .torrent-name {
        max-width: 250px; /* Allow a reasonable max width */
        white-space: normal; /* Allow wrapping */
        word-break: break-all; /* Break long words */
        vertical-align: middle;
    }
    .status-downloading { color: #007bff; }
    .status-seeding { color: #28a745; }
    .status-paused { color: #ffc107; }
    .status-stopped { color: #dc3545; }
    .status-checking { color: #17a2b8; }
    .status-error { color: #dc3545; font-weight: bold; }
    .status-unknown { color: #6c757d; }
    .badge-sonarr { background-color: #0d6efd; color: white; }
    .badge-radarr { background-color: #ffc107; color: black; }
    /* Removed table-hover as it might conflict if index.html has its own general table styling for dark mode */
</style>

<!-- Removed main container, header, and flashed messages. Assumes index.html provides overall structure. -->
<!-- The content will be injected into #rtorrent-content-container -->

{% if error_message %}
    <div class="alert alert-danger mt-3" role="alert"> {# Added mt-3 for spacing #}
        <strong>Erreur rTorrent :</strong> {{ error_message }}
    </div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-3 mt-3"> {# Added mt-3 #}
    <h4 class="mb-0">Liste des Torrents rTorrent</h4> {# Retaining a title for the section within the tab #}
    <a href="#" onclick="event.preventDefault(); isRtorrentContentLoaded = false; loadRtorrentView();" class="btn btn-info btn-sm">
        <i class="fas fa-sync-alt"></i> Actualiser
    </a>
</div>

{% if torrents_with_assoc is defined and torrents_with_assoc %}
    <div id="batch-actions-container" class="mb-3" style="display: none;">
        <div class="card bg-dark border-secondary">
            <div class="card-body">
                <h5 class="card-title"><span id="selected-torrent-count">0</span> item(s) sélectionné(s)</h5>
                <p class="card-text">Choisissez une action à appliquer à tous les items sélectionnés.</p>
                <div class="btn-group" role="group" aria-label="Batch Actions">
                    <button class="btn btn-primary" id="batch-repatriate-btn" style="display: none;"><i class="bi bi-cloud-download"></i> Rapatrier</button>
                    <button class="btn btn-success" id="batch-mark-processed-btn" style="display: none;"><i class="bi bi-check-circle"></i> Marquer Traité</button>
                    <button class="btn btn-info" id="batch-retry-repatriation-btn" style="display: none;"><i class="bi bi-arrow-clockwise"></i> Réessayer Rapatriement</button>
                    <button class="btn btn-warning" id="batch-forget-btn" style="display: none;"><i class="bi bi-eraser"></i> Oublier Association</button>
                    <button class="btn btn-secondary" id="batch-ignore-btn" style="display: none;"><i class="bi bi-slash-circle"></i> Ignorer Déf.</button>
                    <button class="btn btn-danger" id="batch-delete-btn">
                        <i class="bi bi-trash-fill"></i> Supprimer la sélection
                    </button>
                </div>
                <div class="form-check form-switch d-inline-block ms-3 align-middle">
                    <input class="form-check-input" type="checkbox" id="delete-data-checkbox">
                    <label class="form-check-label" for="delete-data-checkbox">Supprimer les données (pour l'action Supprimer)</label>
                </div>
            </div>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-striped table-hover table-sm caption-top table-dark"> {# Added table-dark to match index.html general theme #}
            <caption>Liste des torrents actifs et pré-associations. Les vitesses sont en Ko/s.</caption>
            <thead class="table-dark">
                <tr>
                    <th style="width: 3%;"><input class="form-check-input" type="checkbox" id="select-all-torrents"></th>
                    <th>Nom</th>
                    <th>Taille (Go)</th>
                    <th>Progrès (%)</th>
                    <th>Ratio</th>
                    <th>DL / UL</th>
                    <th>Statut rTorrent</th>
                    <th>Label rTorrent</th>
                    <th>Pré-association MMS</th>
                    <th>Statut MMS</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for torrent_item in torrents_with_assoc %}
                    {% set torrent = torrent_item.details %}
                    {% set association = torrent_item.association %}
                    <tr data-mms-status="{{ torrent.mms_status or 'unknown' }}" data-association-exists="{{ 'true' if association else 'false' }}">
                        <td><input class="form-check-input torrent-checkbox" type="checkbox" data-torrent-hash="{{ torrent.hash }}"></td>
                        <td><span class="torrent-name" title="{{ torrent.name }}">{{ torrent.name }}</span></td>
                        <td>{{ (torrent.size_bytes / (1024*1024*1024)) | round(2) if torrent.size_bytes else '0.00' }}</td>
                        <td>{{ torrent.progress_percent | round(1) if torrent.progress_percent is not none else 'N/A' }}%</td>
                        <td>{{ torrent.ratio | round(2) if torrent.ratio is not none else 'N/A' }}</td>
                        <td>
                            <span class="text-success">{{ (torrent.down_rate_bytes_sec / 1024) | round(1) if torrent.down_rate_bytes_sec is not none else '0.0' }}</span> /
                            <span class="text-primary">{{ (torrent.up_rate_bytes_sec / 1024) | round(1) if torrent.up_rate_bytes_sec is not none else '0.0' }}</span>
                        </td>
                        <td class="status-{{ torrent.status_text | lower | replace(' ', '-') if torrent.status_text else 'unknown' }}">
                            {{ torrent.status_text if torrent.status_text else 'Inconnu' }}
                        </td>
                        <td>
                            {% if torrent.label %}
                                <span class="badge {% if torrent.label == config_label_sonarr %}badge-sonarr{% elif torrent.label == config_label_radarr %}badge-radarr{% else %}bg-secondary text-white{% endif %}">
                                    {{ torrent.label }}
                                </span>
                            {% else %}
                                <span class="text-muted">Aucun</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if association %}
                                <span class="badge {% if association.app_type == 'sonarr' %}badge-sonarr{% elif association.app_type == 'radarr' %}badge-radarr{% endif %}">
                                    {{ association.app_type | capitalize }}: {{ association.original_name | truncate(30) }}
                                    <small>(ID: {{ association.target_id }})</small>
                                </span>
                            {% else %}
                                <span class="text-muted">Aucune</span>
                            {% endif %}
                        </td>
                        <td>
                            {% set status = torrent.mms_status %}
                            {% if status == 'completed_by_sonarr' or status == 'completed_by_radarr' %}
                                <span class="badge bg-success">Traité (Auto)</span>
                                <small class="d-block text-muted">Géré par {{ 'Sonarr' if 'sonarr' in status else 'Radarr' }}</small>
                            {% elif status == 'completed_manual' %}
                                <span class="badge bg-info">Traité (MMS)</span>
                            {% elif status == 'processed_manual' %}
                                <span class="badge bg-secondary">Traité (Manuel)</span>
                            {% elif status and 'error' in status %}
                                <span class="badge bg-danger">Erreur</span>
                                <small class="d-block text-muted" title="{{ association.status_message if association else '' }}">{{ status }}</small>
                            {% elif status == 'unknown' %}
                                <span class="badge bg-secondary">Inconnu</span>
                            {% else %}
                                <span class="badge bg-primary">{{ status | replace('_', ' ') | capitalize }}</span>
                            {% endif %}
                        </td>
                        <!-- Nouvelle cellule pour les actions -->
                        <td>
                            {% set torrent = torrent_item.details %}
                            {% set association = torrent_item.association %}
                            {% set status = torrent.mms_status %}

                            <div class="d-flex flex-wrap" style="gap: 3px;">

                                {# Ce bouton est maintenant TOUJOURS PRÉSENT #}
                                <button class="btn btn-sm btn-outline-primary repatriate-btn"
                                        data-hash="{{ torrent.hash }}"
                                        title="Télécharger le contenu de ce torrent vers le dossier de staging local">
                                    <i class="bi bi-cloud-download"></i> Rapatrier
                                </button>

                                {# Le bouton 'Traité' reste conditionnel #}
                                {% if torrent.mms_status and torrent.mms_status not in ['completed', 'completed_manual', 'processed_manual'] %}
                                    <button class="btn btn-sm btn-outline-success mark-processed-btn"
                                            data-hash="{{ torrent.hash }}"
                                            title="Marquer ce torrent comme traité manuellement (ne sera plus processé)">
                                        <i class="bi bi-check-circle"></i> Traité
                                    </button>
                                {% endif %}

                                {# --- NOUVELLE ACTION : RÉESSAYER LE RAPATRIEMENT --- #}
                                {% if status and status.strip().lower() == 'error_rapatriation' %}
                                    <button class="btn btn-sm btn-outline-primary retry-repatriation-btn"
                                            data-hash="{{ torrent.hash }}"
                                            title="Relancer le processus de rapatriement pour cet item.">
                                        <i class="bi bi-arrow-clockwise"></i> Réessayer
                                    </button>
                                {% endif %}

                                {# --- ACTION : MAPPER (pour les torrents inconnus) --- #}
                                {% if status == 'unknown' %}
                                    <button class="btn btn-sm btn-outline-info open-mapping-modal-btn"
                                            data-torrent-name="{{ torrent.name }}"
                                            title="Associer ce torrent à un média dans Sonarr/Radarr">
                                        <i class="bi bi-link-45deg"></i> Mapper
                                    </button>
                                {% endif %}

                                {# --- ACTION : FORCER L'IMPORT (pour les torrents en staging) --- #}
                                {% if status == 'pending_mms_import' and association %}
                                    <button class="btn btn-sm btn-outline-success force-import-btn"
                                            data-torrent-hash="{{ torrent.hash }}"
                                            title="Forcer le traitement de cet item depuis le staging">
                                        <i class="bi bi-play-circle-fill"></i> Forcer Import
                                    </button>
                                {% endif %}

                                {# --- ACTION : OUBLIER L'ASSOCIATION (pour tous les torrents connus de MMS) --- #}
                                {% if status != 'unknown' and association %}
                                    <button class="btn btn-sm btn-outline-warning forget-association-btn"
                                            data-torrent-hash="{{ torrent.hash }}"
                                            title="Supprimer l'association MMS. Le torrent restera dans rTorrent.">
                                        <i class="bi bi-eraser"></i> Oublier
                                    </button>
                                    <button class="btn btn-sm btn-danger ignore-torrent-btn"
                                            data-hash="{{ torrent.hash }}"
                                            title="Ajouter ce torrent à la liste noire et le supprimer de la vue. Cette action est irréversible.">
                                        <i class="bi bi-trash-fill"></i> Ignorer Déf.
                                    </button>
                                {% endif %}

                                {# Le bouton de suppression individuelle est retiré pour laisser place à l'action groupée #}

                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% elif not error_message %}
    <div class="alert alert-info mt-3" role="alert">
        Aucun torrent trouvé dans rTorrent ou la liste n'a pas pu être chargée.
    </div>
{% endif %}

<!-- Bootstrap JS should be loaded by the main layout, so removed from here -->
