<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Seedbox Staging UI - MediaManagerSuite</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Font Awesome (pour les icônes) - Optionnel mais recommandé -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        body {
            padding-top: 20px;
            padding-bottom: 60px; /* Espace pour le contenu en bas et les modales */
        }
        .action-buttons form, .action-buttons button {
            margin-right: 5px;
            margin-bottom: 5px; /* Pour les petits écrans où les boutons pourraient wrapper */
        }
        .table th, .table td {
            vertical-align: middle;
        }
        #sonarrSearchResults .list-group-item img,
        #radarrSearchResults .list-group-item img {
            width: 60px; /* Ajuster la taille des posters */
            height: auto;
            margin-right: 15px;
            border-radius: 4px;
        }
        #sonarrSearchResults .list-group-item,
        #radarrSearchResults .list-group-item {
            cursor: default; /* Pour ne pas avoir le curseur texte sur les items */
        }
        .modal-lg { max-width: 800px; } /* Augmenter la taille des modales pour plus de contenu */
    </style>
</head>
<body>
    <div class="container mt-4">
        <header class="pb-3 mb-4 border-bottom">
            <a href="{{ url_for('seedbox_ui.index') }}" class="d-flex align-items-center text-dark text-decoration-none">
                <span class="fs-4">MediaManagerSuite - Gestion Staging Seedbox</span>
            </a>
            <!-- Tu pourrais ajouter un lien vers le portail principal ici si tu en as un -->
            <!-- <a href="{{ url_for('home') }}">Retour au portail</a> -->
        </header>

        <h1>Contenu du Staging</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if items_details %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th scope="col">Nom</th>
                            <th scope="col">Type</th>
                            <th scope="col">Taille</th>
                            <th scope="col">Dernière modification</th>
                            <th scope="col" style="min-width: 350px;">Actions</th> <!--  Augmenter la largeur pour les boutons -->
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items_details %}
                        <tr>
                            <td>
                                {% if item.is_dir %}
                                    <i class="fas fa-folder text-warning"></i> <!-- Icône dossier -->
                                {% else %}
                                    <i class="fas fa-file text-info"></i> <!-- Icône fichier -->
                                {% endif %}
                                {{ item.name }}
                            </td>
                            <td>{{ "Dossier" if item.is_dir else "Fichier" }}</td>
                            <td>{{ item.size_readable }}</td>
                            <td>{{ item.last_modified }}</td>
                            <td class="action-buttons">
                                {% if not item.name.endswith("(Erreur de lecture)") %}
                                    {% if can_scan_sonarr %}
                                    <form action="{{ url_for('seedbox_ui.scan_sonarr', item_name=item.name) }}" method="POST" style="display: inline-block;">
                                        <button type="submit" class="btn btn-sm btn-info" title="Scanner avec Sonarr (Import Automatique)">
                                            <i class="fas fa-tv"></i> Sonarr
                                        </button>
                                    </form>
                                    {% endif %}
                                    {% if can_scan_radarr %}
                                    <form action="{{ url_for('seedbox_ui.scan_radarr', item_name=item.name) }}" method="POST" style="display: inline-block;">
                                        <button type="submit" class="btn btn-sm btn-warning" title="Scanner avec Radarr (Import Automatique)">
                                            <i class="fas fa-film"></i> Radarr
                                        </button>
                                    </form>
                                    {% endif %}

                                    <div class="mt-1"> <!-- Pour séparer un peu les boutons de mapping -->
                                        {% if can_scan_sonarr %}
                                        <button class="btn btn-sm btn-outline-primary" onclick="openSonarrSearchModal('{{ item.name | e }}', '{{ 'directory' if item.is_dir else 'file' }}')" title="Rechercher et mapper manuellement avec Sonarr">
                                            <i class="fas fa-search"></i> Mapper Sonarr
                                        </button>
                                        {% endif %}
                                        {% if can_scan_radarr %}
                                        <button class="btn btn-sm btn-outline-secondary" onclick="openRadarrSearchModal('{{ item.name | e }}', '{{ 'directory' if item.is_dir else 'file' }}')" title="Rechercher et mapper manuellement avec Radarr">
                                            <i class="fas fa-search"></i> Mapper Radarr
                                        </button>
                                        {% endif %}
                                    </div>

                                    <form action="{{ url_for('seedbox_ui.delete_item', item_name=item.name) }}" method="POST" style="display: inline-block;" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer \'{{ item.name | e }}\' ?');">
                                        <button type="submit" class="btn btn-sm btn-danger mt-1" title="Supprimer l'item du staging">
                                            <i class="fas fa-trash-alt"></i> Supprimer
                                        </button>
                                    </form>
                                {% else %}
                                    <span class="text-muted">Actions non disponibles (erreur)</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% elif not get_flashed_messages(category_filter=['danger']) %}
            <div class="alert alert-info" role="alert">
                Le dossier de staging est vide ou non accessible.
            </div>
        {% endif %}
    </div>

    <!-- Modal Sonarr -->
    <div class="modal fade" id="sonarrSearchModal" tabindex="-1" aria-labelledby="sonarrSearchModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sonarrSearchModalLabel">Rechercher et Mapper avec Sonarr</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Mapping pour : <strong id="sonarrItemToMap"></strong> (<span id="sonarrItemType"></span>)</p>
                    <input type="hidden" id="sonarrOriginalItemName" value="">
                    <input type="hidden" id="sonarrOriginalItemType" value="">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="sonarrSearchQuery" placeholder="Nom de la série...">
                        <button class="btn btn-outline-primary" type="button" onclick="executeSonarrSearch()">
                            <i class="fas fa-search"></i> Rechercher
                        </button>
                    </div>
                    <div id="sonarrSearchResults" style="max-height: 400px; overflow-y: auto;">
                        <!-- Les résultats de la recherche s'afficheront ici -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Radarr -->
    <div class="modal fade" id="radarrSearchModal" tabindex="-1" aria-labelledby="radarrSearchModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="radarrSearchModalLabel">Rechercher et Mapper avec Radarr</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Mapping pour : <strong id="radarrItemToMap"></strong> (<span id="radarrItemType"></span>)</p>
                    <input type="hidden" id="radarrOriginalItemName" value="">
                    <input type="hidden" id="radarrOriginalItemType" value="">
                     <div class="input-group mb-3">
                        <input type="text" class="form-control" id="radarrSearchQuery" placeholder="Titre du film...">
                        <button class="btn btn-outline-primary" type="button" onclick="executeRadarrSearch()">
                            <i class="fas fa-search"></i> Rechercher
                        </button>
                    </div>
                    <div id="radarrSearchResults" style="max-height: 400px; overflow-y: auto;">
                        <!-- Les résultats de la recherche s'afficheront ici -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle JS (Popper.js included) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
    {# // const csrfToken = "{{ csrf_token() }}"; // Nécessite que le formulaire de la page principale contienne un champ csrf_token() #}

    // Fonction helper pour échapper les chaînes pour JavaScript
    function escapeJsString(str) {
        if (str === null || typeof str === 'undefined') {
            return '';
        }
        return String(str)
            .replace(/\\/g, '\\\\')
            .replace(/'/g, "\\'")
            .replace(/"/g, '\\"')
            .replace(/\n/g, '\\n')
            .replace(/\r/g, '\\r')
            .replace(/\t/g, '\\t')
            .replace(/</g, '\\u003C')
            .replace(/>/g, '\\u003E')
            .replace(/&/g, '\\u0026');
    }

    function getCleanedSearchTerm(itemName) {
        let cleanedName = itemName;
        cleanedName = cleanedName.replace(/\.(mkv|mp4|avi|srt|nfo|jpg)$/i, '');
        cleanedName = cleanedName.replace(/[\.\[\(]?\d{3,4}p[\.\]\)]?/i, '');
        cleanedName = cleanedName.replace(/[\.\[\(]?(hdtv|web-dl|webrip|bluray|x264|x265|hevc|ac3|dts)[\.\]\)]?/gi, '');
        cleanedName = cleanedName.replace(/[\.\[\(]?S\d{1,2}(E\d{1,2}(-E?\d{1,2})?)?[\.\]\)]?/i, '');
        cleanedName = cleanedName.replace(/[\.\[\(]?\d{4}[\.\]\)]?$/, '');
        cleanedName = cleanedName.replace(/[\._]+/g, ' ').replace(/\s+/g, ' ').trim();
        return cleanedName || itemName.split('.')[0];
    }

    function openSonarrSearchModal(itemName, itemType) {
        document.getElementById('sonarrItemToMap').textContent = itemName;
        document.getElementById('sonarrOriginalItemName').value = itemName;
        document.getElementById('sonarrOriginalItemType').value = itemType;
        document.getElementById('sonarrItemType').textContent = itemType === 'directory' ? 'Dossier' : 'Fichier';
        document.getElementById('sonarrSearchQuery').value = getCleanedSearchTerm(itemName);
        document.getElementById('sonarrSearchResults').innerHTML = '';
        var sonarrModal = new bootstrap.Modal(document.getElementById('sonarrSearchModal'));
        sonarrModal.show();
    }

    function openRadarrSearchModal(itemName, itemType) {
        document.getElementById('radarrItemToMap').textContent = itemName;
        document.getElementById('radarrOriginalItemName').value = itemName;
        document.getElementById('radarrOriginalItemType').value = itemType;
        document.getElementById('radarrItemType').textContent = itemType === 'directory' ? 'Dossier' : 'Fichier';
        document.getElementById('radarrSearchQuery').value = getCleanedSearchTerm(itemName);
        document.getElementById('radarrSearchResults').innerHTML = '';
        var radarrModal = new bootstrap.Modal(document.getElementById('radarrSearchModal'));
        radarrModal.show();
    }

    async function executeSonarrSearch() {
        const query = document.getElementById('sonarrSearchQuery').value;
        if (!query.trim()) {
            document.getElementById('sonarrSearchResults').innerHTML = '<p class="text-warning">Veuillez entrer un terme de recherche.</p>';
            return;
        }
        const resultsDiv = document.getElementById('sonarrSearchResults');
        resultsDiv.innerHTML = `<div class="d-flex align-items-center"><strong role="status">Recherche en cours...</strong><div class="spinner-border ms-auto" aria-hidden="true"></div></div>`;

        try {
            const response = await fetch(`{{ url_for('seedbox_ui.search_sonarr_api') }}?query=${encodeURIComponent(query)}`);
            if (!response.ok) {
                let errorData;
                try { errorData = await response.json(); } catch (e) { errorData = { error: "Erreur de communication avec le serveur." }; }
                throw new Error(errorData.error || `Erreur HTTP: ${response.status}`);
            }
            const results = await response.json();

            if (results.length === 0) {
                resultsDiv.innerHTML = '<p class="text-muted">Aucune série trouvée pour ce terme.</p>';
                return;
            }

            let html = '<ul class="list-group mt-3">';
            results.forEach(series => {
                let posterUrl = 'https://via.placeholder.com/60x90?text=N/A';
                if (series.images && series.images.length > 0) {
                    const posterObj = series.images.find(img => img.coverType === 'poster');
                    if (posterObj) posterUrl = posterObj.remoteUrl || posterObj.url;
                }

                const escapedSeriesTitle = escapeJsString(series.title); // UTILISATION DE L'ÉCHAPPEMENT

                html += `
                    <li class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <img src="${posterUrl}" alt="Poster de ${escapedSeriesTitle}" class="img-fluid rounded" style="max-height: 90px;">
                            </div>
                            <div class="col">
                                <strong>${series.title}</strong> (${series.year || 'N/A'})
                                <br><small class="text-muted">Statut: ${series.status || 'Inconnu'} | TVDB ID: ${series.tvdbId || 'N/A'}</small>
                                <p class="mb-0 small">${(series.overview || '').substring(0, 150)}${(series.overview || '').length > 150 ? '...' : ''}</p>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-success btn-sm" onclick="triggerSonarrManualImport(${series.id || 0}, '${escapedSeriesTitle}')" ${series.id ? '' : 'disabled title="Cette série n\'est pas encore dans Sonarr. Ajout non implémenté."'} >
                                    <i class="fas fa-link"></i> Mapper
                                </button>
                            </div>
                        </div>
                    </li>`;
            });
            html += '</ul>';
            resultsDiv.innerHTML = html;

        } catch (error) {
            resultsDiv.innerHTML = `<p class="text-danger">Erreur lors de la recherche Sonarr: ${error.message}</p>`;
            console.error("Erreur recherche Sonarr:", error);
        }
    }

    async function executeRadarrSearch() {
        const query = document.getElementById('radarrSearchQuery').value;
         if (!query.trim()) {
            document.getElementById('radarrSearchResults').innerHTML = '<p class="text-warning">Veuillez entrer un terme de recherche.</p>';
            return;
        }
        const resultsDiv = document.getElementById('radarrSearchResults');
        resultsDiv.innerHTML = `<div class="d-flex align-items-center"><strong role="status">Recherche en cours...</strong><div class="spinner-border ms-auto" aria-hidden="true"></div></div>`;

        try {
            const response = await fetch(`{{ url_for('seedbox_ui.search_radarr_api') }}?query=${encodeURIComponent(query)}`);
            if (!response.ok) {
                let errorData;
                try { errorData = await response.json(); } catch (e) { errorData = { error: "Erreur de communication avec le serveur." }; }
                throw new Error(errorData.error || `Erreur HTTP: ${response.status}`);
            }
            const results = await response.json();

            if (results.length === 0) {
                resultsDiv.innerHTML = '<p class="text-muted">Aucun film trouvé pour ce terme.</p>';
                return;
            }

            let html = '<ul class="list-group mt-3">';
            results.forEach(movie => {
                let posterUrl = 'https://via.placeholder.com/60x90?text=N/A';
                if (movie.images && movie.images.length > 0) {
                    const posterObj = movie.images.find(img => img.coverType === 'poster');
                    if (posterObj) posterUrl = posterObj.remoteUrl || posterObj.url;
                }

                const escapedMovieTitle = escapeJsString(movie.title); // UTILISATION DE L'ÉCHAPPEMENT

                html += `
                    <li class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <img src="${posterUrl}" alt="Poster de ${escapedMovieTitle}" class="img-fluid rounded" style="max-height: 90px;">
                            </div>
                            <div class="col">
                                <strong>${movie.title}</strong> (${movie.year || 'N/A'})
                                <br><small class="text-muted">Statut: ${movie.status || 'Inconnu'} | TMDB ID: ${movie.tmdbId || 'N/A'}</small>
                                <p class="mb-0 small">${(movie.overview || '').substring(0, 150)}${(movie.overview || '').length > 150 ? '...' : ''}</p>
                            </div>
                            <div class="col-auto">
                                 <button class="btn btn-success btn-sm" onclick="triggerRadarrManualImport(${movie.id || 0}, '${escapedMovieTitle}')" ${movie.id ? '' : 'disabled title="Ce film n\'est pas encore dans Radarr. Ajout non implémenté."'} >
                                    <i class="fas fa-link"></i> Mapper
                                </button>
                            </div>
                        </div>
                    </li>`;
            });
            html += '</ul>';
            resultsDiv.innerHTML = html;

        } catch (error) {
            resultsDiv.innerHTML = `<p class="text-danger">Erreur lors de la recherche Radarr: ${error.message}</p>`;
            console.error("Erreur recherche Radarr:", error);
        }
    }

    async function triggerSonarrManualImport(sonarrSeriesId, seriesTitle) {
        const originalItemName = document.getElementById('sonarrOriginalItemName').value;
        const resultsDiv = document.getElementById('sonarrSearchResults');

        if (sonarrSeriesId === 0) {
            resultsDiv.innerHTML = `<div class="alert alert-warning">Cette série doit d'abord être ajoutée à Sonarr. Ajout non implémenté.</div>`;
            return;
        }

        resultsDiv.innerHTML = `<div class="alert alert-info">Tentative d'import de '${escapeJsString(originalItemName)}' pour la série '${seriesTitle}' (ID: ${sonarrSeriesId})...</div>`; // J'échappe aussi originalItemName ici pour l'affichage

        try {
            const response = await fetch(`{{ url_for('seedbox_ui.trigger_sonarr_import') }}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    item_name: originalItemName,
                    series_id: sonarrSeriesId
                })
            });
            const result = await response.json();

            if (response.ok && result.success) {
                resultsDiv.innerHTML = `<div class="alert alert-success">Importation pour '${escapeJsString(originalItemName)}' vers '${seriesTitle}' initiée. Message: ${result.message || ''}</div>`;
                flashMessageGlobally(`Scan pour '${escapeJsString(originalItemName)}' (série: ${seriesTitle}) envoyé à Sonarr.`, 'success');
                setTimeout(() => {
                    var modalInstance = bootstrap.Modal.getInstance(document.getElementById('sonarrSearchModal'));
                    if (modalInstance) modalInstance.hide();
                    // window.location.reload();
                }, 3000);
            } else {
                throw new Error(result.error || "Erreur inconnue lors de l'initiation de l'importation.");
            }
        } catch (error) {
            resultsDiv.innerHTML = `<div class="alert alert-danger">Erreur lors de l'importation Sonarr: ${error.message}</div>`;
            console.error("Erreur import Sonarr:", error);
        }
    }

    async function triggerRadarrManualImport(radarrMovieId, movieTitle) {
        const originalItemName = document.getElementById('radarrOriginalItemName').value;
        const resultsDiv = document.getElementById('radarrSearchResults');

        if (radarrMovieId === 0) {
            resultsDiv.innerHTML = `<div class="alert alert-warning">Ce film doit d'abord être ajouté à Radarr. Ajout non implémenté.</div>`;
            return;
        }

        resultsDiv.innerHTML = `<div class="alert alert-info">Tentative d'import de '${escapeJsString(originalItemName)}' pour le film '${movieTitle}' (ID: ${radarrMovieId})...</div>`; // J'échappe aussi originalItemName

        try {
            const response = await fetch(`{{ url_for('seedbox_ui.trigger_radarr_import') }}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    item_name: originalItemName,
                    movie_id: radarrMovieId
                })
            });
            const result = await response.json();

            if (response.ok && result.success) {
                resultsDiv.innerHTML = `<div class="alert alert-success">Importation pour '${escapeJsString(originalItemName)}' vers '${movieTitle}' initiée. Message: ${result.message || ''}</div>`;
                flashMessageGlobally(`Scan pour '${escapeJsString(originalItemName)}' (film: ${movieTitle}) envoyé à Radarr.`, 'success');
                setTimeout(() => {
                    var modalInstance = bootstrap.Modal.getInstance(document.getElementById('radarrSearchModal'));
                    if (modalInstance) modalInstance.hide();
                    // window.location.reload();
                }, 3000);
            } else {
                throw new Error(result.error || "Erreur inconnue lors de l'initiation de l'importation.");
            }
        } catch (error) {
            resultsDiv.innerHTML = `<div class="alert alert-danger">Erreur lors de l'importation Radarr: ${error.message}</div>`;
            console.error("Erreur import Radarr:", error);
        }
    }

    function flashMessageGlobally(message, category) {
        const container = document.querySelector('.container');
        const alertHtml = `
            <div class="alert alert-${category} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        const firstHeader = container.querySelector('h1');
        if (firstHeader) {
            firstHeader.insertAdjacentHTML('beforebegin', alertHtml);
        } else {
            container.insertAdjacentHTML('afterbegin', alertHtml);
        }
        const newAlert = container.querySelector('.alert:not(.show)'); // Select a newly added alert
        if (newAlert) {
            new bootstrap.Alert(newAlert); // Initialize it if not already
            newAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Pas besoin d'initialiser explicitement les modales si elles sont déclenchées par data-bs-toggle
    });
    </script>
</body>
</html>