{% extends "layout.html" %}

{% block title %}Seedbox Staging UI - MediaManagerSuite{% endblock %}

{% block head_styles %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        /* Styles specific to seedbox_ui/index.html */
        .action-buttons form, .action-buttons button { margin-right: 3px; margin-bottom: 3px; }
        ul.file-tree, ul.children-list { list-style-type: none; padding-left: 0; }
        .file-tree li > div { display: flex; align-items: center; padding: 0.25rem 0.5rem; border-bottom: 1px solid #eee; }
        .file-tree li > div:hover { background-color: #f8f9fa; }
        .file-tree .toggle-children { cursor: pointer; color: #0d6efd; text-decoration: none; }
        .file-tree .toggle-children i { transition: transform 0.2s ease-in-out; }
        .file-tree .icon-container { width: 25px; text-align: center; flex-shrink: 0; }
        .file-tree .item-name-details { flex-grow: 1; margin-left: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file-tree .item-actions { margin-left: auto; flex-shrink: 0; min-width: 280px; }
        .file-tree .btn-sm { padding: 0.15rem 0.3rem; font-size: 0.75rem; }
        .modal-lg { max-width: 800px; }
        .btn-toolbar .btn { margin-right: 0.5rem; margin-bottom: 0.5rem;}
    </style>
{% endblock %}

{% block content %}
{% macro render_tree_node(node, can_scan_sonarr, can_scan_radarr, level=0) %}
  <li style="margin-left: {{ level * 20 }}px;">
    <div class="tree-node-item d-flex align-items-center">
      <span style="width: 25px; flex-shrink: 0; text-align: center;">
          {% if level == 0 %}
              <input type="checkbox" class="form-check-input staging-item-checkbox"
                     value="{{ node.path_for_actions }}"
                     aria-label="Sélectionner {{ node.name }}"
                     style="margin-top: 0; vertical-align: middle;">
          {% endif %}
       </span>
      <span class="icon-container" style="width: 25px; text-align: center; flex-shrink: 0;">
        {% if node.is_dir and node.children %}
          <a href="#" class="toggle-children me-1" data-bs-toggle="tooltip" title="Déplier/Replier"><i class="fas fa-plus-square"></i></a>
        {% elif node.is_dir %}
          <i class="fas fa-folder text-warning me-1"></i>
        {% else %}
          <i class="fas fa-file text-info me-1"></i>
        {% endif %}
      </span>
      <span class="item-name-details flex-grow-1" title="{{ node.name }}">
         {{ node.name }}
         <small class="text-muted" style="font-size: 0.8em;">
             ({{ node.size_readable if node.size_readable else 'N/A' }}, {{ node.last_modified if node.last_modified else 'N/A' }})
         </small>
         {% if node.association %}
            <div class="mt-1">
                <span class="badge {% if node.association.app_type == 'sonarr' %}bg-primary{% elif node.association.app_type == 'radarr' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                    <i class="fas fa-link"></i> Associé: {{ node.association.app_type | capitalize }} (ID: {{ node.association.target_id }})
                </span>
                <small class="text-muted d-block">Label rTorrent: {{ node.association.label }}</small>
                {% if node.association.torrent_hash %}
                    <small class="text-muted d-block" title="Hash: {{ node.association.torrent_hash }}">Hash: {{ node.association.torrent_hash | truncate(10) }}...</small>
                {% elif node.association.release_name %}
                    <small class="text-muted d-block">Release: {{ node.association.release_name | truncate(20) }}</small>
                {% endif %}
                {% if node.association.status %}
                    <small class="text-muted d-block">Statut: {{ node.association.status | replace('_', ' ') | capitalize }}</small>
                {% endif %}
                <small class="text-muted d-block">Ajouté: {{ node.association.added_at.split('.')[0].replace('T', ' ') if node.association.added_at else 'N/A' }}</small>
            </div>
         {% endif %}
      </span>
      <div class="action-buttons item-actions ms-auto" style="min-width: 300px;">
         {% if not node.name.endswith("(Erreur de lecture)") %}
             {% if level == 0 %}
                {% if can_scan_sonarr %}
                <button class="btn btn-sm btn-outline-primary mb-1 open-map-modal-btn"
                        data-bs-toggle="modal"
                        data-bs-target="#sonarrSearchModal"
                        data-item-path="{{ node.path_for_actions }}"
                        data-item-type="{{ 'directory' if node.is_dir else 'file' }}"
                        data-app-type="sonarr"
                        title="Rechercher et mapper manuellement avec Sonarr"
                        onclick="openSonarrSearchModal('{{ node.path_for_actions | e }}', '{{ 'directory' if node.is_dir else 'file' }}')">
                    <i class="fas fa-search"></i> <span class="d-none d-md-inline">Mapper Sonarr</span>
                </button>

                <button class="btn btn-sm btn-outline-warning text-dark mb-1 open-map-modal-btn"
                        data-bs-toggle="modal"
                        data-bs-target="#radarrSearchModal"
                        data-item-path="{{ node.path_for_actions }}"
                        data-item-type="{{ 'directory' if node.is_dir else 'file' }}"
                        data-app-type="radarr"
                        title="Rechercher et mapper manuellement avec Radarr"
                        onclick="openRadarrSearchModal('{{ node.path_for_actions | e }}', '{{ 'directory' if node.is_dir else 'file' }}')">
                    <i class="fas fa-search"></i> <span class="d-none d-md-inline">Mapper Radarr</span>
                </button>
                {% endif %}
                <form action="{{ url_for('seedbox_ui.delete_item', item_name=node.path_for_actions) }}" method="POST" style="display: inline-block;" onsubmit="return confirm('Supprimer \'{{ node.name | e }}\' ? Cette action est irréversible et supprimera tout le contenu.');">
                    <button type="submit" class="btn btn-sm btn-danger mb-1" title="Supprimer l'item et son contenu du staging">
                        <i class="fas fa-trash-alt"></i> <span class="d-none d-md-inline">Suppr.</span>
                    </button>
                </form>
                {% if node.is_dir %}
                <form action="{{ url_for('seedbox_ui.cleanup_staging_item_action', item_name=node.path_for_actions) }}" method="POST" style="display: inline-block;" onsubmit="return confirm('Nettoyer le dossier \'{{ node.name | e }}\' ?\n\nCeci va :\n1. Supprimer les fichiers orphelins (ex: .nfo, .txt) à l\'intérieur.\n2. Supprimer les sous-dossiers qui deviendraient vides.\n3. Supprimer le dossier principal \'{{ node.name | e }}\' lui-même s\'il devient vide ou ne contient plus que des orphelins (maintenant supprimés).\n\nLes fichiers vidéo ou autres fichiers non-orphelins ne seront PAS supprimés par cette action.');">
                    <button type="submit" class="btn btn-sm btn-warning mb-1" title="Nettoyer le dossier (supprime orphelins et dossiers vides récursivement)">
                        <i class="fas fa-broom"></i> <span class="d-none d-md-inline">Nettoyer</span>
                    </button>
                </form>
                {% endif %}
                {% if node.association %}
                    <form method="POST" action="{{ url_for('seedbox_ui.process_staged_with_association', item_name_in_staging=node.path_for_actions) }}" style="display: inline-block;" onsubmit="return confirm('Lancer l\'importation de \'{{ node.name | e }}\' en utilisant la pré-association ?');">
                        <button type="submit" class="btn btn-sm btn-success mb-1" title="Lancer l'importation en utilisant la pré-association">
                            <i class="fas fa-magic"></i> <span class="d-none d-md-inline">Importer (Associé)</span>
                        </button>
                    </form>
                {% endif %}
             {% endif %}
         {% endif %}
      </div>
    </div>
    {% if node.is_dir and node.children %}
      <ul class="children-list" style="display: none;">
        {% for child_node in node.children %}
          {{ render_tree_node(child_node, can_scan_sonarr, can_scan_radarr, level + 1) }}
        {% endfor %}
      </ul>
    {% endif %}
  </li>
{% endmacro %}

<div class="container mt-4">
    <header class="pb-3 mb-4 border-bottom">
        <a href="{{ url_for('seedbox_ui.index') }}" class="d-flex align-items-center text-dark text-decoration-none">
            <span class="fs-4">MediaManagerSuite - Tableau de Bord Seedbox</span>
        </a>
    </header>

    <div class="d-flex justify-content-end mb-3">
        <div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups">
            <button type="button" class="btn btn-success btn-md" data-bs-toggle="modal" data-bs-target="#addTorrentModal">
                <i class="bi bi-plus-circle-fill"></i> Ajouter un Torrent
            </button>
            <a href="{{ url_for('trigger_sftp_scan_manual') }}" class="btn btn-info btn-md" role="button">
                <i class="bi bi-search"></i> Lancer un Scan SFTP
            </a>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard-content" type="button" role="tab" aria-controls="dashboard-content" aria-selected="true">
                <i class="bi bi-speedometer2"></i> Tableau de Bord
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="finished-files-tab" data-bs-toggle="tab" data-bs-target="#finished-files-content" type="button" role="tab" aria-controls="finished-files-content" aria-selected="false">
                <i class="bi bi-check-circle-fill"></i> Fichiers Terminés
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="rtorrent-view-tab" data-bs-toggle="tab" data-bs-target="#rtorrent-view-content" type="button" role="tab" aria-controls="rtorrent-view-content" aria-selected="false">
                <i class="bi bi-hdd-stack"></i> Vue rTorrent
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="maintenance-tab" data-bs-toggle="tab" data-bs-target="#maintenance-content" type="button" role="tab" aria-controls="maintenance-content" aria-selected="false">
                <i class="bi bi-tools"></i> Maintenance
            </button>
        </li>
    </ul>

    <div class="tab-content" id="mainTabsContent">
        <div class="tab-pane fade show active" id="dashboard-content" role="tabpanel" aria-labelledby="dashboard-tab">
            <div class="d-flex justify-content-between align-items-center mt-3 mb-3">
                <h3><i class="bi bi-folder2-open"></i> Staging Local MediaManagerSuite : <code>{{ staging_dir_display or 'Non configuré' }}</code></h3>
                <div>
                    <button id="batchMapToSonarrBtn" class="btn btn-sm btn-primary me-2" onclick="openBatchSonarrMapModal()" title="Mapper les items sélectionnés du staging à une série Sonarr" disabled>
                        <i class="fas fa-object-group"></i> Mapper Sélection vers Sonarr
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> Actualiser Staging
                    </button>
                </div>
            </div>
            {% if items_tree %}
                <ul class="file-tree">
                    {% for root_node in items_tree %}
                        {{ render_tree_node(root_node, can_scan_sonarr, can_scan_radarr, 0) }}
                    {% endfor %}
                </ul>
            {% elif not get_flashed_messages(category_filter=['danger']) %}
                <div class="alert alert-info mt-3 text-center" role="alert">
                    <i class="bi bi-info-circle-fill"></i> Le dossier de staging est vide, non configuré, ou inaccessible.
                </div>
            {% endif %}

            <hr class="my-4">
            <h4><i class="bi bi-exclamation-triangle-fill text-warning"></i> Items en Attente / Nécessitant Attention</h4>
            {% if items_requiring_attention %}
                <div class="table-responsive">
                    <table class="table table-dark table-striped table-hover mt-3 align-middle caption-top">
                        <caption>Liste des items en attente d'association ou en erreur.</caption>
                        <thead>
                            <tr>
                                <th scope="col" style="width: 25%;">Nom de la Release (Staging/Torrent)</th>
                                <th scope="col" style="width: 10%;">Type</th>
                                <th scope="col" style="width: 20%;">Média Associé (*Arr ID)</th>
                                <th scope="col" style="width: 15%;">Statut Actuel</th>
                                <th scope="col" style="width: 15%;">Dernière MàJ</th>
                                <th scope="col" style="width: 15%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items_requiring_attention %}
                            <tr>
                                <td><code>{{ item.release_name }}</code></td>
                                <td>
                                    {% if item.app_type == 'sonarr' %}<span class="badge bg-primary fs-6">Série</span>
                                    {% elif item.app_type == 'radarr' %}<span class="badge bg-success fs-6">Film</span>
                                    {% else %}<span class="badge bg-secondary fs-6">N/A</span>{% endif %}
                                </td>
                                <td>
                                    {{ item.target_title or 'Non défini' }}
                                    {% if item.target_id %}<small class="text-muted d-block">ID: {{ item.target_id }}</small>{% endif %}
                                </td>
                                <td>
                                    <span class="badge
                                        {% if item.status and 'error' in item.status.lower() %} bg-danger
                                        {% elif item.status and 'processing' in item.status.lower() %} bg-info text-dark
                                        {% elif item.status and 'downloading' in item.status.lower() %} bg-primary
                                        {% elif item.status and 'pending_mms_import' in item.status.lower() %} bg-warning text-dark
                                        {% else %} bg-secondary
                                        {% endif %} fs-6">
                                        {{ item.status_display or item.status or 'Inconnu' }}
                                    </span>
                                    {% if item.status_message %}<small class="text-muted d-block fst-italic" title="{{ item.status_message }}">{{ item.status_message | truncate(50, True) }}</small>{% endif %}
                                </td>
                                <td>{{ item.updated_at_human or item.added_at_human or 'N/A' }}</td>
                                <td>
                                    {% if item.is_in_staging and item.target_id %}
                                        <button class="btn btn-sm btn-success retry-import-btn mb-1 w-100" data-torrent-hash="{{ item.torrent_hash }}" title="Relancer l'import MMS."><i class="bi bi-play-fill"></i> Réessayer Import</button>
                                    {% elif item.is_in_staging and not item.target_id %}
                                         <button class="btn btn-sm btn-warning map-problematic-item-btn mb-1 w-100" data-torrent-hash="{{ item.torrent_hash }}" data-release-name="{{ item.release_name }}" data-app-type="{{ item.app_type }}" title="Mapper cet item."><i class="bi bi-link-45deg"></i> Mapper Item</button>
                                    {% endif %}
                                    <button class="btn btn-sm btn-danger delete-association-btn w-100" data-torrent-hash="{{ item.torrent_hash }}" title="Supprimer cette association."><i class="bi bi-trash-fill"></i> Oublier Assoc.</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-success text-center mt-3" role="alert">
                    <i class="bi bi-check-circle-fill"></i> Aucun item en attente ou en erreur nécessitant une action.
                </div>
            {% endif %}
        </div>

        <div class="tab-pane fade" id="finished-files-content" role="tabpanel" aria-labelledby="finished-files-tab">
            <div class="text-center mt-5" id="finished-files-loader">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Chargement de la liste des fichiers terminés...</p>
            </div>
            <div id="finished-files-container"></div>
        </div>

        <div class="tab-pane fade" id="rtorrent-view-content" role="tabpanel" aria-labelledby="rtorrent-view-tab">
            <div class="text-center mt-5" id="rtorrent-loader">
                <div class="spinner-border text-info" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Chargement de la liste des torrents depuis rTorrent...</p>
            </div>
            <div id="rtorrent-content-container"></div>
        </div>

        <div class="tab-pane fade" id="maintenance-content" role="tabpanel" aria-labelledby="maintenance-tab">
            <h4 class="mt-3 mb-3"><i class="bi bi-tools"></i> Outils de Maintenance</h4>

            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">Gestion des Files d'Attente *Arr</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Visualiser et nettoyer les éléments potentiellement bloqués dans les files d'attente de Sonarr et Radarr.</p>
                    <button class="btn btn-primary" id="load-arr-queue-btn" type="button">
                        <i class="bi bi-hourglass-split"></i> Charger le Gestionnaire
                    </button>
                    <div class="text-center mt-3" id="arr-queue-loader" style="display: none;">
                        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Chargement...</span></div>
                        <p class="mt-2">Chargement du gestionnaire des files d'attente...</p>
                    </div>
                    <div id="arr-queue-container" class="mt-3"></div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">Nettoyage des Dossiers de Travail Seedbox (SFTP)</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Lister le contenu et potentiellement supprimer les fichiers/dossiers orphelins ou inutiles dans les dossiers de travail distants de Sonarr et Radarr sur la seedbox.</p>
                    <div class="btn-group mb-3" role="group" aria-label="Charger dossiers de travail">
                        <button class="btn btn-info" id="load-sonarr-workdir-btn" type="button">
                            <i class="bi bi-tv"></i> Sonarr (Dossier Travail)
                        </button>
                        <button class="btn btn-success" id="load-radarr-workdir-btn" type="button">
                            <i class="bi bi-film"></i> Radarr (Dossier Travail)
                        </button>
                    </div>
                    <div class="text-center mt-3" id="workdir-loader" style="display: none;">
                        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Chargement...</span></div>
                        <p class="mt-2">Chargement des dossiers de travail...</p>
                    </div>
                    <div id="workdir-container" class="mt-3">
                        <!-- Le contenu de remote_seedbox_list.html pour sonarr_working ou radarr_working sera chargé ici -->
                    </div>
                </div>
            </div>

            <!-- Vous pouvez ajouter d'autres cartes ici pour d'autres outils de maintenance -->
        </div>
    </div>
</div>

{% include "seedbox_ui/_modals.html" %}
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        window.appUrls = {
            searchSonarrApi: "{{ url_for('seedbox_ui.search_sonarr_api') }}",
            searchRadarrApi: "{{ url_for('seedbox_ui.search_radarr_api') }}",
            triggerSonarrImport: "{{ url_for('seedbox_ui.trigger_sonarr_import') }}",
            triggerRadarrImport: "{{ url_for('seedbox_ui.trigger_radarr_import') }}",
            forceSonarrImport: "{{ url_for('seedbox_ui.force_sonarr_import_action') }}",
            rtorrentAddTorrent: "{{ url_for('seedbox_ui.rtorrent_add_torrent_action') }}",
            getSonarrRootfolders: "{{ url_for('seedbox_ui.get_sonarr_rootfolders_api') }}",
            getSonarrQualityprofiles: "{{ url_for('seedbox_ui.get_sonarr_qualityprofiles_api') }}",
            getRadarrRootfolders: "{{ url_for('seedbox_ui.get_radarr_rootfolders_api') }}",
            getRadarrQualityprofiles: "{{ url_for('seedbox_ui.get_radarr_qualityprofiles_api') }}",
            batchMapToSonarrSeries: "{{ url_for('seedbox_ui.batch_map_to_sonarr_series_action') }}"
        };
    </script>
    <script src="{{ url_for('static', filename='js/seedbox_ui_modals.js') }}"></script>
<script>
    // ==================================================================== //
    // --- SCRIPT SPÉCIFIQUE À LA PAGE SEEDBOX/INDEX.HTML (VERSION STABLE) ---
    // ==================================================================== //

    // --- SECTION 1 : DÉFINITION DE TOUTES LES FONCTIONS "HELPER" ---

    // NOTE: Les fonctions pour le Batch Mapping du Staging restent inchangées
    function updateBatchActionButtonState(batchMapButton, stagingItemCheckboxes) { /* ... */ }
    function openBatchSonarrMapModal(stagingItemCheckboxes) { /* ... */ }
    async function triggerBatchSonarrMapAction(selectedSeriesIdForBatch, stagingItemCheckboxes) { /* ... */ }

    // --- Fonctions pour la suppression de la file d'attente *Arr ---
    function updateArrDeleteButtonState(arrType) {
        const container = document.querySelector('#arr-queue-container');
        if (!container) return;
        const form = document.querySelector(`#${arrType}QueueForm`);
        if (!form) return;
        const checkedCheckboxes = form.querySelectorAll(`.arr-item-checkbox:checked`);
        const deleteButton = form.querySelector(`button[name="delete_${arrType}_selection"]`);
        if (deleteButton) deleteButton.disabled = checkedCheckboxes.length === 0;
    }

    function handleArrDelete(form, arrType) {
        const selectedCheckboxes = form.querySelectorAll('input[name="selected_item_ids"]:checked');
        if (selectedCheckboxes.length === 0) { alert('Veuillez sélectionner au moins un élément.'); return; }
        
        const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        const removeFromClientCheckbox = form.querySelector(`input[name^="removeFromClient"]`);
        const removeFromClient = removeFromClientCheckbox ? removeFromClientCheckbox.checked : false;
        const url = form.action;
        const dataToSend = { ids: selectedIds, removeFromClient: removeFromClient };
        
        const container = document.querySelector('#arr-queue-container');
        if(container) container.innerHTML = `<div class="text-center mt-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div><p>Suppression en cours...</p></div>`;

        fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(dataToSend) })
            .then(response => {
                if (!response.ok) {
                    // Tente de lire le message d'erreur du backend, sinon utilise le statut HTTP
                    return response.json().then(err => Promise.reject(err), () => Promise.reject({ message: `Erreur du serveur: ${response.status} ${response.statusText}` }));
                }
                return response.json();
            })
            .then(data => {
                alert(data.message || 'Action réussie !');
                document.querySelector('#load-arr-queue-btn')?.click();
            })
            .catch(error => {
                console.error('Erreur lors de la suppression *Arr:', error);
                alert(`Erreur: ${error.message || 'Une erreur inconnue est survenue.'}`);
                // On recharge quand même pour ne pas rester bloqué
                document.querySelector('#load-arr-queue-btn')?.click();
            });
    }

    // --- Fonctions pour la suppression des dossiers de travail ---
    function updateWorkdirDeleteButtonState() {
        const container = document.querySelector('#workdir-container');
        if (!container) return;
        const checkedCheckboxes = container.querySelectorAll('.workdir-item-checkbox:checked');
        const deleteButton = container.querySelector('#delete-workdir-selection-btn');
        if (deleteButton) deleteButton.disabled = checkedCheckboxes.length === 0;
    }

    function handleWorkdirDelete(button) {
        const container = document.querySelector('#workdir-container');
        if (!container) return;
        const checkedCheckboxes = container.querySelectorAll('.workdir-item-checkbox:checked');
        if (checkedCheckboxes.length === 0) { alert('Veuillez sélectionner au moins un élément.'); return; }
        if (!confirm(`Êtes-vous sûr de vouloir supprimer ${checkedCheckboxes.length} élément(s) ?`)) { return; }
        
        const appType = container.dataset.appType;
        if (!appType) { alert('Erreur : Type d\'application non trouvé.'); return; }
        
        const itemsToDelete = Array.from(checkedCheckboxes).map(cb => ({ path: cb.dataset.path, type: cb.dataset.type }));
        const url = `{{ url_for('seedbox_ui.sftp_delete_items_action') }}`.replace('__DUMMY__', appType);
        
        fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ items: itemsToDelete, app_type_source: appType + '_working' }) })
            .then(response => response.json().then(data => ({ ok: response.ok, data })))
            .then(({ ok, data }) => {
                if (ok) {
                    alert(data.message || 'Suppression réussie !');
                    document.querySelector(`#load-${appType}-workdir-btn`)?.click();
                } else { throw new Error(data.error || 'Erreur.'); }
            })
            .catch(error => alert(`Erreur: ${error.message}`));
    }

    // --- SECTION 2 : LE CŒUR DE L'EXÉCUTION (quand le DOM est prêt) ---
    document.addEventListener('DOMContentLoaded', function() {

        // --- Initialisation Générale ---
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) { return new bootstrap.Tooltip(tooltipTriggerEl); });
        
        // --- Logique pour le Batch Mapping du Staging ---
        const batchMapButton = document.getElementById('batchMapToSonarrBtn');
        const stagingItemCheckboxes = document.querySelectorAll('.staging-item-checkbox');
        if (batchMapButton) {
            batchMapButton.addEventListener('click', () => openBatchSonarrMapModal(stagingItemCheckboxes));
        }
        stagingItemCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => updateBatchActionButtonState(batchMapButton, stagingItemCheckboxes));
        });
        updateBatchActionButtonState(batchMapButton, stagingItemCheckboxes);

        // --- Logique pour déplier/replier l'arbre de fichiers ---
        document.querySelector('#dashboard-content').addEventListener('click', function(event) {
            const toggler = event.target.closest('.toggle-children');
            if (toggler) {
                event.preventDefault();
                const childrenList = toggler.closest('li').querySelector('.children-list');
                const icon = toggler.querySelector('i');
                if (childrenList) {
                    const isHidden = childrenList.style.display === 'none' || childrenList.style.display === '';
                    childrenList.style.display = isHidden ? 'block' : 'none';
                    icon.classList.toggle('fa-plus-square', !isHidden);
                    icon.classList.toggle('fa-minus-square', isHidden);
                }
            }
        });

        // --- Logique pour le chargement dynamique de contenu ---
        function loadDynamicContent(buttonSelector, containerSelector, loaderSelector, url) {
            const trigger = document.querySelector(buttonSelector);
            if (!trigger) return;
            
            trigger.addEventListener('click', function() {
                const contentContainer = document.querySelector(containerSelector);
                const loader = document.querySelector(loaderSelector);
                if (!contentContainer || !loader) return;

                loader.style.display = 'block';
                contentContainer.innerHTML = '';
                fetch(url)
                    .then(response => response.ok ? response.text() : Promise.reject(new Error(`Erreur réseau: ${response.statusText}`)))
                    .then(html => {
                        contentContainer.innerHTML = html;
                    })
                    .catch(error => {
                        contentContainer.innerHTML = `<div class="alert alert-danger mt-3">Erreur: ${error.message}</div>`;
                    })
                    .finally(() => {
                        loader.style.display = 'none';
                    });
            });
        }
        
        // Chargement des contenus de la Maintenance
        loadDynamicContent('#load-arr-queue-btn', '#arr-queue-container', '#arr-queue-loader', "{{ url_for('seedbox_ui.queue_manager_view') }}");
        loadDynamicContent('#load-sonarr-workdir-btn', '#workdir-container', '#workdir-loader', "{{ url_for('seedbox_ui.remote_seedbox_view', app_type_target='sonarr_working') }}");
        loadDynamicContent('#load-radarr-workdir-btn', '#workdir-container', '#workdir-loader', "{{ url_for('seedbox_ui.remote_seedbox_view', app_type_target='radarr_working') }}");

        // --- Logique pour l'onglet Maintenance (Écouteurs Délégués) ---
        const maintenanceContainer = document.getElementById('maintenance-content');
        if (maintenanceContainer) {
            maintenanceContainer.addEventListener('submit', function(event) {
                if (event.target.id === 'sonarrQueueForm' || event.target.id === 'radarrQueueForm') {
                    event.preventDefault();
                    handleArrDelete(event.target, (event.target.id === 'sonarrQueueForm') ? 'sonarr' : 'radarr');
                }
            });
            maintenanceContainer.addEventListener('click', function(event) {
                if (event.target.id === 'delete-workdir-selection-btn') {
                    handleWorkdirDelete(event.target);
                }
            });
            maintenanceContainer.addEventListener('change', function(event) {
                if (event.target.classList.contains('arr-item-checkbox')) {
                    updateArrDeleteButtonState(event.target.dataset.arrType);
                }
                if (event.target.classList.contains('workdir-item-checkbox')) {
                    updateWorkdirDeleteButtonState();
                }
            });
        }
        
        // NOTE: Le chargement des onglets principaux est géré séparément pour optimiser
        document.querySelectorAll('#finished-files-tab, #rtorrent-view-tab').forEach(tab => {
            let isContentLoaded = false;
            tab.addEventListener('shown.bs.tab', function(event) {
                if (!isContentLoaded) {
                    const targetId = event.target.getAttribute('data-bs-target');
                    const contentContainer = document.querySelector(targetId);
                    const loader = contentContainer.querySelector('.spinner-border').parentElement;
                    let url = '';
                    if (event.target.id === 'finished-files-tab') {
                        url = "{{ url_for('seedbox_ui.unified_finished_list') }}";
                    } else if (event.target.id === 'rtorrent-view-tab') {
                        url = "{{ url_for('seedbox_ui.rtorrent_list_view') }}";
                    }
                    
                    loader.style.display = 'block';
                    fetch(url)
                        .then(res => res.ok ? res.text() : Promise.reject(new Error('Erreur réseau')))
                        .then(html => {
                            contentContainer.innerHTML = html;
                            isContentLoaded = true;
                        })
                        .catch(err => contentContainer.innerHTML = `<div class="alert alert-danger">${err.message}</div>`)
                        .finally(() => loader.style.display = 'none');
                }
            });
        });
    });

    // --- SECTION 2 : LE CŒUR DE L'EXÉCUTION (quand le DOM est prêt) ---
    document.addEventListener('DOMContentLoaded', function() {

        // --- Initialisation Générale ---
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) { return new bootstrap.Tooltip(tooltipTriggerEl); });
        
        // --- Logique pour le Batch Mapping du Staging (Onglet Tableau de Bord) ---
        const batchMapButton = document.getElementById('batchMapToSonarrBtn');
        const stagingItemCheckboxes = document.querySelectorAll('.staging-item-checkbox');
        if (batchMapButton) {
            batchMapButton.addEventListener('click', () => openBatchSonarrMapModal(stagingItemCheckboxes));
        }
        stagingItemCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => updateBatchActionButtonState(batchMapButton, stagingItemCheckboxes));
        });
        updateBatchActionButtonState(batchMapButton, stagingItemCheckboxes);

        // --- Logique pour déplier/replier l'arbre de fichiers (Onglet Tableau de Bord) ---
        document.querySelector('#dashboard-content').addEventListener('click', function(event) {
            const toggler = event.target.closest('.toggle-children');
            if (toggler) {
                event.preventDefault();
                const childrenList = toggler.closest('li').querySelector('.children-list');
                const icon = toggler.querySelector('i');
                if (childrenList) {
                    const isHidden = childrenList.style.display === 'none' || childrenList.style.display === '';
                    childrenList.style.display = isHidden ? 'block' : 'none';
                    icon.classList.toggle('fa-plus-square', !isHidden);
                    icon.classList.toggle('fa-minus-square', isHidden);
                }
            }
        });

        // --- Logique pour le chargement dynamique des onglets et contenus de la Maintenance ---
        loadDynamicContent('#finished-files-tab', '#finished-files-container', '#finished-files-loader', "{{ url_for('seedbox_ui.unified_finished_list') }}", true);
        loadDynamicContent('#rtorrent-view-tab', '#rtorrent-view-content', '#rtorrent-loader', "{{ url_for('seedbox_ui.rtorrent_list_view') }}", true);
        loadDynamicContent('#load-arr-queue-btn', '#arr-queue-container', '#arr-queue-loader', "{{ url_for('seedbox_ui.queue_manager_view') }}");
        loadDynamicContent('#load-sonarr-workdir-btn', '#workdir-container', '#workdir-loader', "{{ url_for('seedbox_ui.remote_seedbox_view', app_type_target='sonarr_working') }}");
        loadDynamicContent('#load-radarr-workdir-btn', '#workdir-container', '#workdir-loader', "{{ url_for('seedbox_ui.remote_seedbox_view', app_type_target='radarr_working') }}");

        // --- Logique pour l'onglet Maintenance (Écouteurs Délégués) ---
        const maintenanceContainer = document.getElementById('maintenance-content');
        if (maintenanceContainer) {
            maintenanceContainer.addEventListener('submit', function(event) {
                if (event.target.id === 'sonarrQueueForm' || event.target.id === 'radarrQueueForm') {
                    event.preventDefault();
                    handleArrDelete(event.target, (event.target.id === 'sonarrQueueForm') ? 'sonarr' : 'radarr');
                }
            });
            maintenanceContainer.addEventListener('click', function(event) {
                if (event.target.id === 'delete-workdir-selection-btn') {
                    handleWorkdirDelete(event.target);
                }
            });
            maintenanceContainer.addEventListener('change', function(event) {
                if (event.target.classList.contains('arr-item-checkbox')) {
                    updateArrDeleteButtonState(event.target.dataset.arrType);
                }
                if (event.target.classList.contains('workdir-item-checkbox')) {
                    updateWorkdirDeleteButtonState();
                }
            });
        }
    });
</script>
{% endblock %}