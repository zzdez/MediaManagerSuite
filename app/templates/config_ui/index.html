{% extends "layout.html" %}

{% block head_styles %}
    {{ super() }}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
{% endblock %}

{% block content %}
<div class="container">
    <h1>Configuration de l'Application</h1>
    <p class="text-muted">Modifiez les valeurs ci-dessous et sauvegardez pour mettre à jour votre fichier <code>.env</code> et la configuration de recherche.</p>

    <form method="post" action="{{ url_for('config_ui.save_config') }}">
        {% for item in config_items %}
            {% if item.type == 'header' %}
                <h3 class="mt-4 mb-3">{{ item.text }}</h3>
            {% elif item.type == 'variable' %}
                <div class="mb-3">
                    <label for="{{ item.key }}" class="form-label"><code>{{ item.key }}</code></label>
                    <input type="{{ 'password' if item.is_password else 'text' }}"
                           class="form-control"
                           id="{{ item.key }}"
                           name="{{ item.key }}"
                           value="{{ item.value }}">
            {% elif item.type == 'textarea' %}
                <div class="mb-3">
                    <label for="{{ item.key }}" class="form-label"><code>{{ item.key }}</code></label>
                    <textarea class="form-control"
                              id="{{ item.key }}"
                              name="{{ item.key }}"
                              rows="3">{{ item.value }}</textarea>
                    {% if item.description %}
                        <div class="form-text text-muted fst-italic">{{ item.description }}</div>
                    {% endif %}
                </div>
                    {% if item.description %}
                        <div class="form-text text-muted fst-italic">{{ item.description }}</div>
                    {% endif %}
                </div>
            {% elif item.type == 'comment' %}
                <p class="text-muted fst-italic">{{ item.text }}</p>
            {% elif item.type == 'description' %}
                 <p class="text-muted">{{ item.text }}</p>
            {% elif item.type == 'spacer' %}
                <hr class="my-4">
            {% endif %}
        {% endfor %}

        <hr class="my-4">

        <h3 class="mt-4 mb-3">Sauvegardes Automatiques</h3>
        <p class="text-muted">Configurez la fréquence des sauvegardes automatiques et le nombre de copies à conserver. Les sauvegardes incluent tous les fichiers <code>.json</code> de configuration.</p>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="BACKUP_SCHEDULE" class="form-label"><code>BACKUP_SCHEDULE</code></label>
                <select class="form-select" id="BACKUP_SCHEDULE" name="BACKUP_SCHEDULE">
                    <option value="disabled" {% if backup_config.schedule == 'disabled' %}selected{% endif %}>Désactivée</option>
                    <option value="hourly" {% if backup_config.schedule == 'hourly' %}selected{% endif %}>Toutes les heures</option>
                    <option value="daily" {% if backup_config.schedule == 'daily' %}selected{% endif %}>Tous les jours</option>
                    <option value="weekly" {% if backup_config.schedule == 'weekly' %}selected{% endif %}>Toutes les semaines</option>
                </select>
                <div class="form-text text-muted fst-italic">Fréquence à laquelle une sauvegarde est créée.</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="BACKUP_RETENTION" class="form-label"><code>BACKUP_RETENTION</code></label>
                <input type="number" class="form-control" id="BACKUP_RETENTION" name="BACKUP_RETENTION" value="{{ backup_config.retention }}" min="1">
                <div class="form-text text-muted fst-italic">Nombre maximum de sauvegardes à conserver.</div>
            </div>
        </div>

        <hr class="my-5">

        <h3 class="mt-4 mb-3">Catégories de Recherche Prowlarr</h3>
        <p class="text-muted">Sélectionnez les catégories à inclure dans les recherches "Sonarr" et "Radarr". Les badges indiquent quels indexers actifs proposent chaque catégorie.</p>

<div class="row">
    <!-- Colonne Sonarr -->
    <div class="col-md-6">
        <h4><i class="fas fa-tv"></i> Écosystème Sonarr</h4>
        <div class="card p-3" style="max-height: 500px; overflow-y: auto;">
            {% for category in all_categories %}
                <!-- Conteneur principal pour un item de catégorie, avec une marge inférieure solide -->
                <div class="mb-4">
                    <!-- Ligne 1: Uniquement la checkbox et le label -->
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="sonarr_categories" value="{{ category.id }}" id="sonarr-cat-{{ category.id }}"
                        {% if category.id|int in search_config.sonarr_categories %}checked{% endif %}>
                        <label class="form-check-label" for="sonarr-cat-{{ category.id }}">
                            {{ category.name }} <span class="text-muted small">({{ category.id }})</span>
                        </label>
                    </div>
                    <!-- Ligne 2: Le conteneur des badges, en tant que frère et non enfant de form-check -->
                    <div class="ps-4 mt-1 d-flex flex-wrap">
                        {% for indexer in category.indexers %}
                            <span class="badge bg-secondary me-1 mb-1">{{ indexer }}</span>
                        {% endfor %}
                    </div>
                </div>
            {% else %}
                <p class="text-warning">Aucune catégorie Prowlarr n'a pu être chargée. Vérifiez la configuration et les logs.</p>
            {% endfor %}
        </div>
    </div>

    <!-- Colonne Radarr -->
    <div class="col-md-6">
        <h4><i class="fas fa-film"></i> Écosystème Radarr</h4>
        <div class="card p-3" style="max-height: 500px; overflow-y: auto;">
            {% for category in all_categories %}
                 <!-- Conteneur principal pour un item de catégorie, avec une marge inférieure solide -->
                 <div class="mb-4">
                    <!-- Ligne 1: Uniquement la checkbox et le label -->
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="radarr_categories" value="{{ category.id }}" id="radarr-cat-{{ category.id }}"
                        {% if category.id|int in search_config.radarr_categories %}checked{% endif %}>
                        <label class="form-check-label" for="radarr-cat-{{ category.id }}">
                            {{ category.name }} <span class="text-muted small">({{ category.id }})</span>
                        </label>
                    </div>
                    <!-- Ligne 2: Le conteneur des badges, en tant que frère et non enfant de form-check -->
                    <div class="ps-4 mt-1 d-flex flex-wrap">
                        {% for indexer in category.indexers %}
                            <span class="badge bg-secondary me-1 mb-1">{{ indexer }}</span>
                        {% endfor %}
                    </div>
                </div>
            {% else %}
                 <p class="text-warning">Aucune catégorie Prowlarr n'a pu être chargée. Vérifiez la configuration et les logs.</p>
            {% endfor %}
        </div>
    </div>
</div>

        <button type="submit" class="btn btn-primary mt-4 w-100">Sauvegarder Toute la Configuration</button>
    </form>

    <hr class="my-5">

    <!-- Section Gestion des Sauvegardes -->
    <h3 class="mt-4 mb-3">Gestion des Sauvegardes</h3>
    <div class="card">
        <div class="card-body">
            <p class="card-text text-muted">Gérez vos sauvegardes existantes. Vous pouvez lancer une sauvegarde manuelle, restaurer une version précédente ou supprimer d'anciennes sauvegardes.</p>
            <button type="button" id="manual-backup-btn" class="btn btn-secondary mb-3">
                <i class="fas fa-save"></i> Lancer une sauvegarde manuelle
            </button>
            <div id="backup-list-container">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <hr class="my-5">

    <!-- Section dédiée au mapping Plex -->
    <div>
        <h3 class="mt-4 mb-3">Mapping des Dossiers Plex <i class="fas fa-project-diagram"></i></h3>
        <p class="text-muted">Associez chaque chemin de dossier de vos bibliothèques Plex à un dossier racine Sonarr ou Radarr correspondant, et assignez-lui un type. Ce mapping est essentiel pour la fonctionnalité de déplacement de médias.</p>

        <!-- Datalist pour les suggestions de type -->
        <datalist id="media-types-suggestions">
            <option value="FILM"></option>
            <option value="SÉRIE"></option>
            <option value="DOCUMENTAIRE_FILM"></option>
            <option value="DOCUMENTAIRE_SÉRIE"></option>
            <option value="ANIME_FILM"></option>
            <option value="ANIME_SÉRIE"></option>
        </datalist>

        <div id="plex-mapping-container" class="mb-4">
            <!-- Le contenu sera généré dynamiquement par JavaScript -->
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
            </div>
        </div>
        <button type="button" id="save-plex-mappings-btn" class="btn btn-secondary w-100">Sauvegarder les Mappings Plex</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
$(document).ready(function() {
    // --- GESTION DES SAUVEGARDES ---
    const backupContainer = $('#backup-list-container');

    function renderBackupList(backups) {
        if (!backups || backups.length === 0) {
            backupContainer.html('<div class="alert alert-info">Aucune sauvegarde disponible.</div>');
            return;
        }

        const table = $(`
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Fichier</th>
                        <th>Date de création</th>
                        <th>Taille</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        `);

        const tbody = table.find('tbody');
        backups.forEach(backup => {
            const row = $(`
                <tr>
                    <td><code>${backup.filename}</code></td>
                    <td>${backup.created_at}</td>
                    <td>${backup.size}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary restore-btn" data-filename="${backup.filename}" title="Restaurer">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-btn" data-filename="${backup.filename}" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `);
            tbody.append(row);
        });

        backupContainer.html(table);
    }

    function fetchBackups() {
        backupContainer.html('<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Chargement...</span></div></div>');
        fetch('{{ url_for("config_ui.get_backups_list") }}')
            .then(response => response.json())
            .then(data => {
                renderBackupList(data);
            })
            .catch(error => {
                backupContainer.html('<div class="alert alert-danger">Erreur lors du chargement des sauvegardes.</div>');
                console.error('Error fetching backups:', error);
            });
    }

    // --- Configuration de Toastr ---
    toastr.options = {
        "closeButton": true,
        "progressBar": true,
        "positionClass": "toast-top-right",
        "timeOut": "5000",
    };

    // --- EVENEMENTS SAUVEGARDE ---
    $('#manual-backup-btn').on('click', function() {
        const btn = $(this);
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Création...');
        fetch('{{ url_for("config_ui.manual_backup") }}', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    toastr.success(data.message);
                    fetchBackups(); // Rafraîchir la liste
                } else {
                    toastr.error(data.message);
                }
            })
            .catch(error => toastr.error('Erreur de communication lors de la sauvegarde.'))
            .finally(() => btn.prop('disabled', false).html('<i class="fas fa-save"></i> Lancer une sauvegarde manuelle'));
    });

    backupContainer.on('click', '.restore-btn', function() {
        const filename = $(this).data('filename');
        if (confirm(`Êtes-vous sûr de vouloir restaurer la sauvegarde "${filename}" ?\nCela écrasera vos fichiers de configuration actuels.`)) {
            fetch(`/configuration/backups/${filename}/restore`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        toastr.success(data.message);
                        // Pas de rafraîchissement nécessaire, mais on peut flasher un message de succès
                    } else {
                        toastr.error(data.message);
                    }
                })
                .catch(error => toastr.error('Erreur de communication lors de la restauration.'));
        }
    });

    backupContainer.on('click', '.delete-btn', function() {
        const filename = $(this).data('filename');
        if (confirm(`Êtes-vous sûr de vouloir supprimer la sauvegarde "${filename}" ?`)) {
            fetch(`/configuration/backups/${filename}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        toastr.success(data.message);
                        fetchBackups(); // Rafraîchir la liste
                    } else {
                        toastr.error(data.message);
                    }
                })
                .catch(error => toastr.error('Erreur de communication lors de la suppression.'));
        }
    });

    // Chargement initial des sauvegardes
    fetchBackups();


    // --- GESTION DU MAPPING PLEX ---
    const container = $('#plex-mapping-container');
    const saveBtn = $('#save-plex-mappings-btn');
    let plexLibraries = [];
    let sonarrFolders = [];
    let radarrFolders = [];
    let currentMappings = {};

    function renderMappings() {
        container.empty();
        if (!plexLibraries || plexLibraries.length === 0) {
            container.html('<div class="alert alert-warning">Aucune bibliothèque Plex de type film ou série n\'a été trouvée.</div>');
            return;
        }

        plexLibraries.forEach(lib => {
            const libCard = $(`
                <div class="card mb-3">
                    <div class="card-header">
                        <i class="fas fa-${lib.type === 'show' ? 'tv' : 'film'}"></i>
                        <strong>${lib.name}</strong>
                    </div>
                    <ul class="list-group list-group-flush"></ul>
                </div>
            `);
            const locationList = libCard.find('ul');

            lib.locations.forEach(location => {
                const arrFolders = lib.type === 'show' ? sonarrFolders : radarrFolders;
                const arrType = lib.type === 'show' ? 'Sonarr' : 'Radarr';

                // Trouver le mapping existant pour ce chemin spécifique
                const existingMapping = currentMappings[lib.name]?.find(m => m.path === location);

                const arrOptions = arrFolders.map(folder => {
                    const isSelected = existingMapping && existingMapping.root_folder === folder.path;
                    return `<option value="${folder.path}" ${isSelected ? 'selected' : ''}>${folder.path} (${folder.freeSpace_formatted})</option>`;
                }).join('');

                const mediaType = existingMapping?.type || (lib.type === 'show' ? 'SÉRIE' : 'FILM');

                const listItem = $(`
                    <li class="list-group-item" data-plex-lib-name="${lib.name}" data-plex-path="${location}">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <label class="form-label mb-0 small text-muted">Chemin Plex</label>
                                <p class="form-control-plaintext py-1">${location}</p>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label mb-0 small text-muted">Dossier ${arrType}</label>
                                <select class="form-select form-select-sm" data-mapping="root_folder">
                                    <option value="">-- Non mappé --</option>
                                    ${arrOptions}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label mb-0 small text-muted">Type de Média</label>
                                <input type="text" class="form-control form-control-sm" list="media-types-suggestions" value="${mediaType}" data-mapping="type">
                            </div>
                        </div>
                    </li>
                `);
                locationList.append(listItem);
            });
            container.append(libCard);
        });
    }

    fetch('{{ url_for("api.get_mapping_data") }}')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                container.html(`<div class="alert alert-danger">Erreur: ${data.error}</div>`);
                return;
            }
            plexLibraries = data.plex_libraries || [];
            sonarrFolders = data.sonarr_root_folders || [];
            radarrFolders = data.radarr_root_folders || [];
            currentMappings = data.current_mappings || {};
            renderMappings();
        })
        .catch(error => {
            container.html(`<div class="alert alert-danger">Impossible de charger les données de mapping. Vérifiez la connexion aux services.</div>`);
            console.error('Error fetching mapping data:', error);
        });

    saveBtn.on('click', function() {
        const newMappings = {};

        container.find('li[data-plex-lib-name]').each(function() {
            const item = $(this);
            const libName = item.data('plex-lib-name');
            const plexPath = item.data('plex-path');
            const rootFolder = item.find('[data-mapping="root_folder"]').val();
            const mediaType = item.find('[data-mapping="type"]').val();

            if (!rootFolder) return; // Ne pas sauvegarder les non-mappés

            if (!newMappings[libName]) {
                newMappings[libName] = [];
            }

            newMappings[libName].push({
                path: plexPath,
                root_folder: rootFolder,
                type: mediaType
            });
        });

        saveBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Sauvegarde...');

        fetch('{{ url_for("api.save_mapping_data") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(newMappings),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                toastr.success('Mappings sauvegardés avec succès !');
                currentMappings = newMappings;
            } else {
                toastr.error('Erreur lors de la sauvegarde : ' + (data.error || 'Erreur inconnue'));
            }
        })
        .catch(error => {
            toastr.error('Une erreur de communication est survenue.');
            console.error('Error saving mappings:', error);
        })
        .finally(() => {
            saveBtn.prop('disabled', false).text('Sauvegarder les Mappings Plex');
        });
    });
});
</script>
{% endblock %}
