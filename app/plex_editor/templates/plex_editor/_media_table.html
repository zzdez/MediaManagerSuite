{% if items %}
    <table class="table table-dark table-striped table-hover mt-4 align-middle" id="plex-results-table">
        <thead>
            <tr>
                <th scope="col" style="width: 3%;"><input type="checkbox" class="form-check-input" id="select-all-checkbox"></th>
                <th scope="col" class="sortable-header" data-sort-by="title" style="width: 35%;">Titre</th>
                <th scope="col" class="sortable-header" data-sort-by="library" style="width: 12%;">Bibliothèque</th>
                <th scope="col" class="sortable-header" data-sort-by="size" data-sort-type="size" style="width: 8%;">Taille</th>
                <th scope="col" class="sortable-header" data-sort-by="added" data-sort-type="date" style="width: 8%;">Ajout</th>
                <th scope="col" class="sortable-header" data-sort-by="view_status" data-sort-type="text" style="width: 8%;">Statut Visionnage</th>
                <th scope="col" class="sortable-header" data-sort-by="production_status" data-sort-type="text" style="width: 8%;">Statut Production</th>
                <th scope="col" style="width: 18%;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr data-rating="{{ item.userRating or 0 }}"
                data-incomplete="{{ 'true' if item.type == 'show' and item.is_incomplete else 'false' }}"
                data-media-type-from-mapping="{{ item.media_type_from_mapping }}"
                data-custom-media-type="{{ item.custom_media_type }}"
                data-rating-key="{{ item.ratingKey }}">
                <td><input type="checkbox" class="form-check-input item-checkbox" data-rating-key="{{ item.ratingKey }}"></td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <img src="{{ item.poster_url or url_for('static', filename='img/placeholder.png') }}"
                                 alt="Poster for {{ item.title }}"
                                 style="width: 50px; height: 75px; object-fit: cover; border-radius: 4px;">
                        </div>
                        <div>
                            <a href="#" class="text-white item-title-link"
                               data-bs-toggle="modal"
                               data-bs-target="#item-details-modal"
                               data-rating-key="{{ item.ratingKey }}">
                                {{ item.title }}
                            </a>
                            <small class="d-block text-muted">Année: {{ item.year }}</small>
                            {% if item.userRating is not none and item.userRating > 0 %}
                                <div class="star-rating">
                                    {% set star_rating = item.userRating / 2 %}
                                    {% for i in range(star_rating|int) %}<i class="bi bi-star-fill"></i>{% endfor %}
                                    {% if (star_rating - (star_rating|int)) >= 0.5 %}<i class="bi bi-star-half"></i>{% endif %}
                                    {% set full_stars = (star_rating + 0.5)|int %}
                                    {% for i in range(5 - full_stars) %}<i class="bi bi-star"></i>{% endfor %}
                                </div>
                            {% endif %}
                            {% if item.original_title and item.original_title|lower != item.title|lower %}
                                <small class="d-block" style="color: #6c757d; font-style: italic;">(Titre Original: {{ item.original_title }})</small>
                            {% endif %}
                            {% if item.title_sort and item.title_sort|lower != item.title|lower %}
                                <small class="d-block" style="color: #6c757d; font-style: italic;">(Titre de Tri: {{ item.title_sort }})</small>
                            {% endif %}
                        </div>
                    </div>
                    {% if item.file_path %}
                    <div class="mt-2 filepath-cell" style="font-size: 0.8em;">
                        <code class="text-muted">{{ item.file_path }}</code>
                        <button class="btn btn-outline-secondary btn-sm ms-2 py-0 copy-path-btn"
                                title="Copier le chemin"
                                data-path="{{ item.file_path }}">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                    {% endif %}
                </td>
                <td><span class="badge bg-secondary">{{ item.library_name }}</span></td>
                <td>{{ item.total_size_display if item.total_size_display else 'N/A' }}</td>
                <td>{{ item.addedAt.strftime('%Y-%m-%d') if item.addedAt else 'N/A' }}</td>
                <td class="view-status-cell" data-rating-key="{{ item.ratingKey }}">
                    {% if item.type == 'show' %}
                        {% if item.viewed_episodes == 0 and item.total_episodes > 0 %}
                            <span class="badge bg-warning text-dark">Non vue</span>
                        {% elif item.viewed_episodes == item.total_episodes and item.total_episodes > 0 %}
                            <span class="badge bg-success">Vue</span>
                        {% elif item.total_episodes > 0 %}
                            <span class="badge bg-info">Commencée</span>
                        {% else %}
                            <span class="badge bg-secondary">Inconnu</span>
                        {% endif %}
                        {% if item.total_episodes > 0 %}
                        <small class="d-block text-muted mt-1">
                            {{ item.viewed_episodes }} / {{ item.total_episodes }} ép.
                            {% if item.is_incomplete %}
                                <span class="badge bg-danger ms-1" title="Des épisodes diffusés sont manquants selon Sonarr.">
                                    <i class="bi bi-exclamation-triangle-fill"></i>
                                </span>
                            {% endif %}
                        </small>
                        {% endif %}
                    {% elif item.isWatched %}
                        <span class="badge bg-success">Vu</span>
                    {% else %}
                        <span class="badge bg-warning text-dark">Non Vu</span>
                    {% endif %}
                </td>
                <td class="production-status-cell">
                    {% if item.type == 'show' and item.production_status %}
                        {% if item.production_status == 'En Production' %}
                            <span class="badge bg-primary">{{ item.production_status }}</span>
                        {% elif item.production_status == 'Terminée' %}
                            <span class="badge bg-secondary">{{ item.production_status }}</span>
                        {% elif item.production_status == 'À venir' %}
                            <span class="badge bg-info-subtle text-dark">{{ item.production_status }}</span>
                        {% endif %}
                    {% endif %}
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-light toggle-watched-btn"
                            title="Basculer Vu/Non Vu"
                            data-rating-key="{{ item.ratingKey }}">
                        <i class="bi bi-eye-fill"></i>
                    </button>

                    {# --- NOUVELLE LOGIQUE POUR LE BOUTON BANDE-ANNONCE --- #}
                    {% set status = item.trailer_status or 'NONE' %}
                    {% if status == 'LOCKED' %}
                        {% set btn_class = 'btn-outline-success' %}
                        {% set btn_icon = 'bi-film' %}
                        {% set btn_title = 'Bande-annonce verrouillée' %}
                    {% elif status == 'UNLOCKED' %}
                        {% set btn_class = 'btn-outline-primary' %}
                        {% set btn_icon = 'bi-film' %}
                        {% set btn_title = 'Plusieurs bandes-annonces trouvées (non verrouillé)' %}
                    {% else %} {# 'NONE' #}
                        {% set btn_class = 'btn-outline-danger' %}
                        {% set btn_icon = 'bi-film' %}
                        {% set btn_title = 'Aucune bande-annonce trouvée' %}
                    {% endif %}
                    <button class="btn btn-sm {{ btn_class }} find-and-play-trailer-btn"
                            data-title="{{ item.title }}"
                            data-year="{{ item.year }}"
                            data-media-type="{{ item.media_type_for_trailer }}"
                            data-external-id="{{ item.external_id }}"
                            title="{{ btn_title }}">
                        <i class="bi {{ btn_icon }}"></i>
                    </button>

                    {% if item.type == 'movie' %}
                    <button class="btn btn-sm btn-outline-primary archive-movie-btn"
                            title="Archiver le film"
                            data-bs-toggle="modal" data-bs-target="#archiveMovieModal"
                            data-rating-key="{{ item.ratingKey }}"
                            data-title="{{ item.title }}">
                        <i class="bi bi-archive-fill"></i> <span class="d-none d-md-inline">Archiver</span>
                    </button>
                    {% elif item.type == 'show' %}
                    <button class="btn btn-sm btn-outline-primary archive-show-btn"
                            title="Archiver la série"
                            data-bs-toggle="modal" data-bs-target="#archiveShowModal"
                            data-rating-key="{{ item.ratingKey }}"
                            data-title="{{ item.title }}"
                            data-leaf-count="{{ item.leafCount }}"
                            data-viewed-leaf-count="{{ item.viewedLeafCount }}">
                        <i class="bi bi-archive-fill"></i> <span class="d-none d-md-inline">Archiver</span>
                    </button>
                    <button class="btn btn-sm btn-outline-warning reject-show-btn"
                            title="Rejeter la série (Oublier)"
                            data-bs-toggle="modal" data-bs-target="#rejectShowModal"
                            data-rating-key="{{ item.ratingKey }}"
                            data-title="{{ item.title }}">
                        <i class="bi bi-eraser-fill"></i> <span class="d-none d-md-inline">Rejeter</span>
                    </button>
                    {# Bouton Gérer les Saisons obsolète remplacé par le bouton Gérer ci-dessous #}
                    {# <a href="{{ url_for('plex_editor.manage_seasons', rating_key=item.ratingKey) }}"
                       class="btn btn-sm btn-outline-info"
                       title="Gérer les saisons">
                        <i class="bi bi-list-task"></i> <span class="d-none d-md-inline">Saisons</span>
                    </a> #}
                    <button class="btn btn-sm btn-outline-success manage-series-btn"
                            title="Gérer la série et les saisons"
                            data-bs-toggle="modal"
                            data-bs-target="#series-management-modal"
                            data-rating-key="{{ item.ratingKey }}"
                            data-title="{{ item.title }}">
                        <i class="bi bi-gear-fill"></i> <span class="d-none d-md-inline">Gérer</span>
                    </button>
                    {% endif %}

                    <button class="btn btn-sm btn-outline-info move-media-btn"
                            title="Déplacer le média vers un autre dossier"
                            data-bs-toggle="modal" data-bs-target="#move-media-modal"
                            data-media-id="{{ item.ratingKey }}"
                            data-media-title="{{ item.title }}"
                            data-media-type="{{ 'sonarr' if item.type == 'show' else 'radarr' }}">
                        <i class="bi bi-folder-symlink"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-item-btn"
                            title="Supprimer définitivement de Plex"
                            data-rating-key="{{ item.ratingKey }}"
                            data-item-title="{{ item.title }}">
                        <i class="bi bi-trash-fill"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% elif external_suggestions %}
    <div class="mt-4">
        <h4>Aucun résultat dans Plex. Suggestions externes :</h4>
        <hr>
        {% for suggestion in external_suggestions %}
            {% include 'plex_editor/_external_suggestions.html' %}
        {% endfor %}
    </div>
{% elif archived_results %}
    <div class="mt-4">
        <h4>Résultats trouvés dans les archives :</h4>
        <hr>
        {% for item in archived_results %}
            <div class="card bg-dark text-white mb-3">
                <div class="row g-0">
                    <div class="col-md-2">
                        <img src="{{ item.poster_url or url_for('static', filename='img/placeholder.png') }}" class="img-fluid rounded-start" alt="Poster for {{ item.title }}">
                    </div>
                    <div class="col-md-10">
                        <div class="card-body">
                            <h5 class="card-title">
                                {{ item.title }} <span class="badge bg-secondary">{{ item.year }}</span>
                                <span class="badge bg-info">Archivé</span>
                            </h5>
                            <p class="card-text"><small class="text-muted">ID Externe: {{ item.external_id }}</small></p>
                            <p class="card-text">{{ item.summary | truncate(300) }}</p>

                            {% if item.archive_history %}
                                <hr>
                                <h6><i class="bi bi-clock-history"></i> Historique de visionnage archivé :</h6>
                                <ul class="list-unstyled">
                                    {% for history in item.archive_history %}
                                        <li>
                                            <small>
                                                Archivé par l'utilisateur <strong>{{ history.user_id }}</strong> le {{ history.archived_at | date_format }}.<br>
                                                Statut :
                                                {% if item.media_type == 'show' and history.watched_status.viewed_seasons %}
                                                    <strong>Saisons vues : {{ history.watched_status.viewed_seasons | join(', ') }}</strong>
                                                {% elif item.media_type == 'movie' and history.watched_status.is_watched %}
                                                    <strong>Vu</strong>
                                                {% else %}
                                                    <i>Informations de visionnage non disponibles.</i>
                                                {% endif %}
                                            </small>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <div class="text-center mt-4">
        <p>Aucun média trouvé pour les filtres sélectionnés.</p>
    </div>
{% endif %}

{% macro date_format(iso_date_string) %}
    {% set dt = iso_date_string | to_datetime %}
    {{ dt.strftime('%d/%m/%Y à %H:%M') if dt else 'Date inconnue' }}
{% endmacro %}
