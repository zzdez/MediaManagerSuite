{% extends "layout.html" %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Gestionnaire de Bibliothèque Plex</h1>

    <!-- Zone des Filtres -->
    <div class="card bg-dark text-white mb-4">
        <div class="card-body">
            <h5 class="card-title">Filtres</h5>
            <div class="row g-3 align-items-end">
                <!-- Filtre Utilisateur -->
                <div class="col-md-3">
                    <label for="user-select" class="form-label">Utilisateur Plex</label>
                    <select id="user-select" class="form-select">
                        <option selected>Chargement...</option>
                        {# La liste des utilisateurs sera chargée ici par JS #}
                    </select>
                </div>
                <!-- Filtre Bibliothèque -->
                <div class="col-md-4">
                    <label for="library-select" class="form-label">Bibliothèque(s)</label>
                    <select id="library-select" class="form-select" multiple disabled>
                        {# La liste des bibliothèques sera chargée ici par JS #}
                    </select>
                </div>
                <!-- Autres filtres (statut, etc.) -->
                <div class="col-md-3">
                    <label for="status-filter" class="form-label">Statut</label>
                    <select id="status-filter" class="form-select">
                        <option value="all" selected>Tous</option>
                        <option value="unwatched">Non vus</option>
                        <option value="watched">Vus</option>
                    </select>
                </div>
                <!-- Bouton d'application -->
                <div class="col-md-2">
                    <button id="apply-filters-btn" class="btn btn-primary w-100">Appliquer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Zone des Résultats -->
    <div id="plex-items-loader" class="text-center mt-5" style="display: none;">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Chargement des médias...</p>
    </div>
    <div id="plex-items-container">
        <p class="text-center text-muted">Veuillez sélectionner un utilisateur et une bibliothèque pour afficher les médias.</p>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const userSelect = document.getElementById('user-select');
    const librarySelect = document.getElementById('library-select');
    const applyBtn = document.getElementById('apply-filters-btn');
    const loader = document.getElementById('plex-items-loader');
    const itemsContainer = document.getElementById('plex-items-container');

    // --- 1. Charger les utilisateurs au démarrage ---
    fetch("{{ url_for('plex_editor.get_plex_users') }}")
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(users => {
            userSelect.innerHTML = '<option value="" selected disabled>Choisir un utilisateur...</option>';
            if (users && users.length > 0) {
                users.forEach(user => {
                    const option = new Option(user.text, user.id);
                    userSelect.add(option);
                });
            } else {
                 userSelect.innerHTML = '<option selected>Aucun utilisateur trouvé</option>';
            }
        })
        .catch(error => {
            console.error("Erreur lors du chargement des utilisateurs:", error);
            userSelect.innerHTML = '<option selected>Erreur de chargement des utilisateurs</option>';
            // Optionnel: afficher l'erreur dans la console ou une alerte
            itemsContainer.innerHTML = `<p class="text-danger text-center">Erreur chargement utilisateurs: ${error.message}</p>`;
        });

    // --- 2. Charger les bibliothèques quand un utilisateur est choisi ---
    userSelect.addEventListener('change', function () {
        const userId = this.value;
        librarySelect.innerHTML = '<option>Chargement...</option>';
        librarySelect.disabled = true;
        itemsContainer.innerHTML = '<p class="text-center text-muted">Veuillez sélectionner une ou plusieurs bibliothèques.</p>';


        if (!userId) {
            librarySelect.innerHTML = '';
            librarySelect.disabled = true;
            return;
        }

        // Construction de l'URL pour get_user_libraries
        const libraryUrl = "{{ url_for('plex_editor.get_user_libraries', user_id='USER_ID_PLACEHOLDER') }}".replace('USER_ID_PLACEHOLDER', userId);

        fetch(libraryUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(libraries => {
                librarySelect.innerHTML = ''; // Vide la liste
                if (libraries && libraries.length > 0) {
                    libraries.forEach(lib => {
                        const option = new Option(lib.text, lib.id);
                        librarySelect.add(option);
                    });
                    librarySelect.disabled = false;
                } else {
                    librarySelect.innerHTML = '<option selected>Aucune bibliothèque trouvée</option>';
                    itemsContainer.innerHTML = '<p class="text-center text-muted">Aucune bibliothèque trouvée pour cet utilisateur.</p>';
                }
            })
            .catch(error => {
                console.error("Erreur lors du chargement des bibliothèques:", error);
                librarySelect.innerHTML = '<option selected>Erreur de chargement des bibliothèques</option>';
                itemsContainer.innerHTML = `<p class="text-danger text-center">Erreur chargement bibliothèques: ${error.message}</p>`;
            });
    });

    // --- 3. Logique du bouton "Appliquer" ---
    applyBtn.addEventListener('click', function() {
        const userId = userSelect.value;
        const selectedLibraries = Array.from(librarySelect.selectedOptions).map(opt => opt.value);
        const statusFilter = document.getElementById('status-filter').value;

        if (!userId || selectedLibraries.length === 0) {
            // Utiliser le conteneur d'items pour les messages d'alerte simples plutôt que alert()
            itemsContainer.innerHTML = '<p class="text-center text-warning">Veuillez sélectionner un utilisateur et au moins une bibliothèque.</p>';
            return;
        }

        // Affiche le spinner et vide le conteneur
        loader.style.display = 'block';
        itemsContainer.innerHTML = '';

        fetch("{{ url_for('plex_editor.get_media_items') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                userId: userId,
                libraryKeys: selectedLibraries,
                statusFilter: statusFilter
                // Ajoute d'autres filtres ici si nécessaire
            })
        })
        .then(response => {
            if (!response.ok) {
                // Essayer de lire le message d'erreur JSON du backend si disponible
                return response.json().then(errData => {
                    throw new Error(`Erreur HTTP: ${response.status} - ${errData.error || response.statusText}`);
                }).catch(() => {
                    // Fallback si le corps n'est pas JSON ou si response.json() échoue aussi
                    throw new Error(`Erreur HTTP: ${response.status} - ${response.statusText}`);
                });
            }
            return response.text(); // Attend du HTML partiel
        })
        .then(html => {
            loader.style.display = 'none';
            itemsContainer.innerHTML = html;
        })
        .catch(error => {
            loader.style.display = 'none';
            itemsContainer.innerHTML = `<div class="alert alert-danger text-center">Erreur lors du chargement des médias: ${error.message}</div>`;
            console.error('Erreur lors du chargement des médias:', error);
        });
    });

    // --- Gestionnaire d'événements pour les actions sur les items (dont suppression) ---
    itemsContainer.addEventListener('click', function(event) {
        const deleteButton = event.target.closest('.delete-item-btn');

        if (deleteButton) {
            event.preventDefault(); // Empêche toute action par défaut du bouton
            const ratingKey = deleteButton.dataset.ratingKey;
            const itemTitle = deleteButton.dataset.itemTitle || 'cet élément'; // Fallback title

            if (confirm(`Êtes-vous sûr de vouloir supprimer définitivement "${itemTitle}" de Plex ?`)) {

                deleteButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                deleteButton.disabled = true;

                // --- NOUVELLE LOGIQUE DE CONSTRUCTION D'URL ---
                // 'plex_editor.index' donne '/plex_editor/'
                // On concatène avec 'api/media_item/' et ratingKey
                const finalUrl = `{{ url_for('plex_editor.index') }}api/media_item/${ratingKey}`;

                fetch(finalUrl, { // Utilise la nouvelle URL
                    method: 'DELETE',
                    headers: {
                        // Si CSRF est nécessaire pour les requêtes DELETE API, l'ajouter ici
                        // 'X-CSRFToken': '{{ csrf_token() }}' // Exemple
                    }
                })
                .then(response => response.json()) // Attend une réponse JSON du backend
                .then(data => {
                    if (data.status === 'success') {
                        deleteButton.closest('tr').remove(); // Supprime la ligne du tableau
                        // Afficher une notification plus discrète si possible (toast)
                        // Pour l'instant, une simple alerte.
                        // alert(data.message); // Peut-être un peu intrusif, à voir
                        console.log(data.message); // Log pour confirmation

                        // Optionnel: Mettre à jour un compteur ou un message si le tableau devient vide
                        if (itemsContainer.querySelectorAll('tbody tr').length === 0) {
                            itemsContainer.innerHTML = '<p class="text-center text-muted">Aucun média trouvé pour les filtres sélectionnés.</p>';
                        }
                    } else {
                        throw new Error(data.message || 'Erreur inconnue lors de la suppression.');
                    }
                })
                .catch(error => {
                    alert(`Erreur lors de la suppression : ${error.message}`);
                    console.error('Erreur de suppression:', error);
                    // Réactive le bouton en cas d'erreur pour permettre une nouvelle tentative
                    deleteButton.innerHTML = '<i class="bi bi-trash-fill"></i>';
                    deleteButton.disabled = false;
                });
            }
        }
        // Ici, on pourrait ajouter des 'else if' pour d'autres boutons d'action (archiver, etc.)
        // const archiveButton = event.target.closest('.archive-item-btn');
        // if (archiveButton) { ... }
    });
});
</script>
{% endblock %}