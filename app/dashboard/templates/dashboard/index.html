{% extends "layout.html" %}

{% block content %}
<div class="container-fluid">
    <h1 class="mt-4">Tableau de Bord des Nouveautés</h1>
    <p>Cliquez sur le bouton pour rechercher les nouvelles publications depuis votre dernière visite.</p>
    <button id="refresh-btn" class="btn btn-primary mb-4">
        <i class="fas fa-sync-alt"></i> Rafraîchir les nouveautés
    </button>

    <div id="loading-spinner" style="display: none;" class="text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Chargement...</span>
        </div>
        <p>Recherche en cours...</p>
    </div>

    <div id="torrents-container">
        <!-- Les résultats seront injectés ici -->
    </div>
</div>

<!-- La modale de mapping est définie dans layout.html, nous n'avons pas besoin de la redéfinir ici -->

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
$(document).ready(function() {

    // --- Data passed from backend ---
    const initialTorrents = {{ torrents|tojson }};

    // --- Function to render torrents ---
    function renderTorrents(torrents) {
        const container = $('#torrents-container');
        container.empty();

        if (torrents.length === 0) {
            // No need to display a message on initial load if the list is empty.
            // The user will click refresh to populate it.
        }

        // --- Function to generate status badges ---
        function generateStatusBadges(statuses) {
            if (!statuses || statuses.length === 0) return '';

            const statusMap = {
                'SONARR_MONITORED': { text: 'Sonarr', class: 'bg-primary' },
                'SONARR_OBTAINED': { text: 'Sonarr', class: 'bg-primary' },
                'RADARR_MONITORED': { text: 'Radarr', class: 'bg-warning text-dark' },
                'RADARR_OBTAINED': { text: 'Radarr', class: 'bg-warning text-dark' },
                'PLEX_PRESENT': { text: 'Plex', class: 'bg-purple' },
                'ARCHIVED': { text: 'Archivé', class: 'bg-orange' },
                'UNKNOWN_ID': { text: 'Inconnu', class: 'bg-secondary' }
            };

            // Using a Set to ensure unique badges (e.g., Sonarr obtained implies monitored)
            const badgesHtml = new Set();
            statuses.forEach(status => {
                const badgeInfo = statusMap[status];
                if (badgeInfo) {
                    badgesHtml.add(`<span class="badge ${badgeInfo.class} ms-1">${badgeInfo.text}</span>`);
                }
            });

            return Array.from(badgesHtml).join('');
        }

        torrents.forEach(torrent => {
            const sizeInGB = (torrent.size / (1024 * 1024 * 1024)).toFixed(2);
            const newBadge = torrent.is_new ? '<span class="badge bg-info ms-2">Nouveau</span>' : '';
            const statusBadges = generateStatusBadges(torrent.statuses);
            const isManaged = torrent.statuses && torrent.statuses.length > 0 && !torrent.statuses.includes('UNKNOWN_ID');

            const yearMatch = torrent.title.match(/\b(19[89]\d|20\d{2})\b/);
            const year = yearMatch ? yearMatch[1] : null;

            const detailsButtonHtml = torrent.detailsUrl
                ? `<button class="btn btn-info btn-sm details-btn" data-url="${torrent.detailsUrl}">Détails</button>`
                : `<button class="btn btn-info btn-sm" disabled>Détails</button>`;

            const indexerBadge = torrent.indexer ? `<span class="badge bg-secondary me-1">${torrent.indexer}</span>` : '';
            const categoryBadge = torrent.category ? `<span class="badge bg-dark">${torrent.category}</span>` : '';

            const torrentCard = `
                <div class="card mb-3" id="torrent-card-${torrent.hash}">
                    <div class="card-body">
                        <h5 class="card-title">${torrent.title} ${newBadge}</h5>
                        <div>
                            ${statusBadges}
                        </div>
                        <div class="mt-2">
                            ${indexerBadge}
                            ${categoryBadge}
                        </div>
                        <h6 class="card-subtitle mb-2 mt-2 text-muted">
                            <i class="fas fa-database"></i> ${sizeInGB} GB |
                            <i class="fas fa-arrow-up text-success"></i> ${torrent.seeders} |
                            <i class="fas fa-arrow-down text-danger"></i> ${torrent.leechers}
                        </h6>
                        ${detailsButtonHtml}
                        <button class="btn btn-primary btn-sm download-and-map-btn"
                                data-hash="${torrent.hash}"
                                data-guid="${torrent.guid}"
                                data-title="${torrent.title}"
                                data-download-link="${torrent.downloadUrl}"
                                data-indexer-id="${torrent.indexerId}"
                                data-media-type="${torrent.type}"
                                data-tmdb-id="${torrent.tmdbId || ''}"
                                data-tvdb-id="${torrent.tvdbId || ''}"
                                data-year="${year || ''}"
                                ${isManaged ? 'disabled' : ''}>
                            <i class="fas fa-download"></i> & Mapper
                        </button>
                        <button class="btn btn-secondary btn-sm" data-action="ignore" data-hash="${torrent.hash}">
                            <i class="fas fa-eye-slash"></i> Ignorer
                        </button>
                    </div>
                </div>
            `;
            container.append(torrentCard);
        });
    }

    // --- Initial render on page load ---
    renderTorrents(initialTorrents);

    // --- Event handler for the refresh button ---
    $('#refresh-btn').on('click', function() {
        const button = $(this);
        const spinner = $('#loading-spinner');
        const container = $('#torrents-container');

        button.prop('disabled', true);
        spinner.show();
        container.empty();

        window.currentMediaContext = null;

        $.ajax({
            url: "{{ url_for('dashboard_bp.refresh_torrents') }}",
            type: 'GET',
            success: function(response) {
                if (response.status === 'success') {
                    renderTorrents(response.torrents);
                } else {
                    container.html(`<div class="alert alert-danger">Erreur: ${response.message || 'Une erreur est survenue.'}</div>`);
                }
            },
            error: function() {
                container.html('<div class="alert alert-danger">Erreur de communication avec le serveur.</div>');
            },
            complete: function() {
                button.prop('disabled', false);
                spinner.hide();
            }
        });
    });

    // --- Event delegation for action buttons ---
    $('#torrents-container').on('click', 'button[data-action="ignore"]', function() {
        const torrentId = $(this).data('hash'); // 'hash' data attribute holds the unique ID (hash or guid)
        const cardElement = $(this).closest('.card');

        $.ajax({
            url: "/dashboard/api/ignore",
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ id: torrentId }),
            success: function(response) {
                if (response.status === 'success') {
                    cardElement.fadeOut(500, function() { $(this).remove(); });
                } else {
                    alert('Erreur lors de l_ignorance du torrent: ' + response.message);
                }
            },
            error: function() {
                alert('Erreur de communication avec le serveur.');
            }
        });
    });

    // --- Intelligent Details Button Handler ---
    $('#torrents-container').on('click', '.details-btn', function() {
        const url = $(this).data('url');
        if (!url) return;

        // --- Calculate window position for centering ---
        const windowWidth = 1200;
        const windowHeight = 800;
        const left = (screen.width / 2) - (windowWidth / 2);
        const top = (screen.height / 2) - (windowHeight / 2);
        const windowFeatures = `width=${windowWidth},height=${windowHeight},top=${top},left=${left},resizable=yes,scrollbars=yes`;

        // Special handling for YGG API URLs via our backend proxy
        if (url.includes('yggapi.eu')) {
            const proxyUrl = `/dashboard/api/proxy?url=${encodeURIComponent(url)}`;
            fetch(proxyUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Proxy network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.link) {
                        window.open(data.link, 'MMS_Details_Window', windowFeatures);
                    } else {
                        // Fallback to opening the original URL if parsing fails
                        window.open(url, 'MMS_Details_Window', windowFeatures);
                    }
                })
                .catch(error => {
                    console.error('Failed to fetch YGG details via proxy:', error);
                    // Fallback to opening the original URL on error
                    window.open(url, 'MMS_Details_Window', windowFeatures);
                });
        } else {
            // Standard behavior for all other indexers
            window.open(url, 'MMS_Details_Window', windowFeatures);
        }
    });

});
</script>
{% endblock %}
